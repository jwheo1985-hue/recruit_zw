<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì±„ìš© ê´€ë¦¬ ì—ì´ì „íŠ¸</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
:root{--bg:#0b0e16;--s1:#111520;--s2:#181d2c;--s3:#1e2438;--bd:#252c42;--bd2:#2e3650;--blue:#4f9fff;--vio:#8b7cf8;--grn:#34d399;--yel:#fbbf24;--red:#f87171;--mu:#8b95b0;--tx:#e2e8f8;--r:12px;}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--tx);display:flex;height:100vh;overflow:hidden;font-size:14px;}

/* SIDEBAR */
#sb{width:230px;min-width:230px;background:var(--s1);border-right:1px solid var(--bd);display:flex;flex-direction:column;}
.logo{padding:22px 20px 18px;border-bottom:1px solid var(--bd);}
.logo-t{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--blue);letter-spacing:2px;margin-bottom:3px;}
.logo-s{font-size:11px;color:var(--mu);}
.ns{padding:18px 20px 6px;font-size:10px;color:var(--mu);letter-spacing:2px;text-transform:uppercase;}
.ni{display:flex;align-items:center;gap:10px;padding:11px 14px;margin:2px 8px;border-radius:9px;cursor:pointer;color:var(--mu);font-size:13px;font-weight:500;transition:background .15s,color .15s;user-select:none;}
.ni:hover{background:var(--s2);color:var(--tx);}
.ni.active{background:rgba(79,159,255,.13);color:var(--blue);}
.nico{font-size:15px;width:22px;text-align:center;flex-shrink:0;}
.ncnt{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:10px;background:var(--s3);padding:2px 8px;border-radius:20px;color:var(--mu);min-width:24px;text-align:center;}
.ni.active .ncnt{background:rgba(79,159,255,.2);color:var(--blue);}
.sbfoot{margin-top:auto;padding:14px 18px;border-top:1px solid var(--bd);font-size:11px;color:var(--mu);}

/* MAIN */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
#topbar{height:58px;background:var(--s1);border-bottom:1px solid var(--bd);display:flex;align-items:center;padding:0 26px;gap:12px;flex-shrink:0;}
#ptitle{font-size:15px;font-weight:700;flex:1;}
#content{flex:1;overflow-y:auto;padding:26px;scrollbar-width:thin;scrollbar-color:var(--bd2) transparent;}
#content::-webkit-scrollbar{width:5px;}
#content::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:10px;}
.page{display:none;animation:fi .2s ease;}
.page.active{display:block;}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* DASHBOARD / CARDS / TABLE ë“± ìŠ¤íƒ€ì¼ ë™ì¼... */
.srow{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:22px;}
.sc{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);padding:18px 20px;position:relative;overflow:hidden;}
.sc::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.sc.b::after{background:var(--blue)}.sc.v::after{background:var(--vio)}.sc.g::after{background:var(--grn)}.sc.r::after{background:var(--red)}
.sc-l{font-size:11px;color:var(--mu);margin-bottom:10px;}
.sc-v{font-family:'JetBrains Mono',monospace;font-size:30px;font-weight:500;}
.sc.b .sc-v{color:var(--blue)}.sc.v .sc-v{color:var(--vio)}.sc.g .sc-v{color:var(--grn)}.sc.r .sc-v{color:var(--red)}
.sc-s{font-size:11px;color:var(--mu);margin-top:6px;}
.pc{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);padding:20px 22px;margin-bottom:20px;}
.pc h3{font-size:13px;color:var(--mu);margin-bottom:18px;}
.ps{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
.psi{background:var(--s2);border-radius:9px;padding:14px;text-align:center;}
.psi-l{font-size:11px;color:var(--mu);margin-bottom:8px;}
.psi-n{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:500;}
.card{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);overflow:hidden;}
.card-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--bd);}
.card-t{font-size:13px;font-weight:600;}
table{width:100%;border-collapse:collapse;}
th{background:var(--s2);font-size:11px;color:var(--mu);padding:10px 16px;text-align:left;font-weight:500;}
td{padding:11px 16px;font-size:13px;border-bottom:1px solid var(--bd);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tbody tr:hover td{background:rgba(255,255,255,.02);cursor:pointer;}

/* BADGES */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;white-space:nowrap;}
.b-ì„œë¥˜ê²€í† {background:rgba(79,159,255,.15);color:var(--blue);}
.b-1ì°¨ë©´ì ‘{background:rgba(139,124,248,.15);color:var(--vio);}
.b-2ì°¨ë©´ì ‘{background:rgba(251,191,36,.15);color:var(--yel);}
.b-ìµœì¢…í•©ê²©{background:rgba(52,211,153,.15);color:var(--grn);}
.b-ë¶ˆí•©ê²©{background:rgba(248,113,113,.15);color:var(--red);}
.b-ë³´ë¥˜{background:rgba(139,149,176,.15);color:var(--mu);}

/* FILTER / BUTTONS / UPLOAD / AI STATUS / MODAL ë“± ìŠ¤íƒ€ì¼ ë™ì¼... */
.fbar{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:center;}
.sw{flex:1;min-width:200px;position:relative;}
.si{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--mu);pointer-events:none;}
.sw input{padding-left:34px !important;width:100%;}
input,select,textarea{background:var(--s1);border:1px solid var(--bd);border-radius:8px;padding:9px 12px;color:var(--tx);font-size:13px;font-family:inherit;outline:none;transition:border-color .15s;}
input:focus,select:focus,textarea:focus{border-color:var(--blue);}
select option{background:var(--s2);}
textarea{resize:vertical;}
.chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;}
.chip{padding:5px 13px;border-radius:20px;font-size:12px;cursor:pointer;border:1px solid var(--bd);color:var(--mu);background:var(--s1);transition:all .15s;font-weight:500;}
.chip:hover{border-color:var(--blue);color:var(--tx);}
.chip.active{background:rgba(79,159,255,.15);border-color:var(--blue);color:var(--blue);}

.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-family:inherit;font-weight:600;transition:all .15s;white-space:nowrap;}
.bp{background:var(--blue);color:#fff;}.bg{background:var(--s2);color:var(--tx);border:1px solid var(--bd);}.bd-btn{background:rgba(248,113,113,.12);color:var(--red);border:1px solid rgba(248,113,113,.25);}

.upz{border:2px dashed var(--bd2);border-radius:var(--r);padding:52px 32px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:20px;background:var(--s1);}
.upz:hover,.upz.drag{border-color:var(--blue);background:rgba(79,159,255,.04);}
.up-ico{font-size:46px;margin-bottom:14px;}

.ai-status{background:var(--s2);border:1px solid rgba(139,124,248,.3);border-radius:var(--r);padding:20px;margin-bottom:16px;}
.ai-status-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.step-dot{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;}
.step-dot.done{background:rgba(52,211,153,.2);color:var(--grn);}
.step-dot.ing{background:rgba(139,124,248,.2);color:var(--vio);}
.step-dot.wait{background:var(--s3);color:var(--mu);}

.pcard{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);overflow:hidden;margin-bottom:14px;}
.pgrd{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:20px;}
.pf-l{font-size:11px;color:var(--mu);margin-bottom:4px;}
.pf-v{font-size:14px;font-weight:600;}

.aibox{background:var(--s2);border:1px solid rgba(139,124,248,.25);border-radius:var(--r);padding:20px;margin-top:14px;}
.aibox-h{font-size:12px;color:var(--vio);font-family:'JetBrains Mono',monospace;letter-spacing:1px;margin-bottom:14px;}
.aibox-c{font-size:13px;line-height:1.85;white-space:pre-wrap;}

/* PIPELINE / MODAL / DETAIL / TOAST... */
.board{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;align-items:start;}
.bcol{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);overflow:hidden;}
.bcol-h{padding:12px 14px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:7px;font-size:12px;font-weight:600;}
.bcol-b{padding:10px;display:flex;flex-direction:column;gap:8px;min-height:60px;}
.bcard{background:var(--s2);border-radius:8px;padding:12px;cursor:pointer;border:1px solid var(--bd);}

.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:999;align-items:center;justify-content:center;backdrop-filter:blur(2px);}
.overlay.open{display:flex;}
.modal{background:var(--s1);border:1px solid var(--bd2);border-radius:14px;width:580px;max-width:96vw;max-height:88vh;overflow-y:auto;padding:26px;}

.sset{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);padding:22px;margin-bottom:16px;max-width:640px;}

#toast{position:fixed;bottom:22px;right:22px;background:var(--s2);border:1px solid var(--bd2);border-radius:10px;padding:12px 18px;font-size:13px;z-index:9999;pointer-events:none;transform:translateY(80px);opacity:0;transition:all .28s cubic-bezier(.34,1.56,.64,1);}
#toast.show{transform:translateY(0);opacity:1;}
#toast.ok{border-color:var(--grn);}
#toast.err{border-color:var(--red);}

.api-warn{background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.3);border-radius:10px;padding:14px 18px;margin-bottom:20px;font-size:13px;color:var(--yel);display:none;}
.api-warn a{color:var(--blue);cursor:pointer;text-decoration:underline;}
</style>
</head>
<body>

<nav id="sb">
  <div class="logo">
    <div class="logo-t">RECRUIT AI</div>
    <div class="logo-s">ì±„ìš© ê´€ë¦¬ ì—ì´ì „íŠ¸</div>
  </div>
  <div class="ns">ë©”ë‰´</div>
  <div class="ni active" data-pg="dashboard"><span class="nico">ğŸ“Š</span>ëŒ€ì‹œë³´ë“œ</div>
  <div class="ni" data-pg="applicants"><span class="nico">ğŸ‘¥</span>ì§€ì›ì ëª©ë¡<span class="ncnt" id="nc">0</span></div>
  <div class="ni" data-pg="upload"><span class="nico">ğŸ“„</span>ì´ë ¥ì„œ ì—…ë¡œë“œ</div>
  <div class="ni" data-pg="pipeline"><span class="nico">ğŸ”„</span>ì±„ìš© íŒŒì´í”„ë¼ì¸</div>
  <div class="ns">ì„¤ì •</div>
  <div class="ni" data-pg="settings"><span class="nico">âš™ï¸</span>ì„¤ì •</div>
  <div class="sbfoot">ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤</div>
</nav>

<div id="main">
  <div id="topbar">
    <div id="ptitle">ëŒ€ì‹œë³´ë“œ</div>
    <button class="btn bg bsm" onclick="exportJSON()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
    <button class="btn bp" onclick="openAddModal()">+ ì§€ì›ì ì¶”ê°€</button>
  </div>
  <div id="content">

    <div class="page active" id="page-dashboard">
      <div class="srow">
        <div class="sc b"><div class="sc-l">ì „ì²´ ì§€ì›ì</div><div class="sc-v" id="s-total">0</div><div class="sc-s">ëˆ„ì  ë“±ë¡</div></div>
        <div class="sc v"><div class="sc-l">ì§„í–‰ì¤‘</div><div class="sc-v" id="s-active">0</div><div class="sc-s">ê²€í† Â·ë©´ì ‘</div></div>
        <div class="sc g"><div class="sc-l">ìµœì¢…í•©ê²©</div><div class="sc-v" id="s-pass">0</div><div class="sc-s">í•©ê²©ë¥  <span id="s-rate">0</span>%</div></div>
        <div class="sc r"><div class="sc-l">ë¶ˆí•©ê²©</div><div class="sc-v" id="s-fail">0</div><div class="sc-s">íƒˆë½</div></div>
      </div>
      <div class="pc">
        <h3>ë‹¨ê³„ë³„ í˜„í™©</h3>
        <div class="ps">
          <div class="psi"><div class="psi-l">ğŸ“‹ ì„œë¥˜ê²€í† </div><div class="psi-n" style="color:var(--blue)" id="ps0">0</div></div>
          <div class="psi"><div class="psi-l">ğŸ¤ 1ì°¨ë©´ì ‘</div><div class="psi-n" style="color:var(--vio)" id="ps1">0</div></div>
          <div class="psi"><div class="psi-l">ğŸ¯ 2ì°¨ë©´ì ‘</div><div class="psi-n" style="color:var(--yel)" id="ps2">0</div></div>
          <div class="psi"><div class="psi-l">âœ… ìµœì¢…í•©ê²©</div><div class="psi-n" style="color:var(--grn)" id="ps3">0</div></div>
          <div class="psi"><div class="psi-l">âŒ ë¶ˆí•©ê²©</div><div class="psi-n" style="color:var(--red)" id="ps4">0</div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-hd"><span class="card-t">ìµœê·¼ ì§€ì›ì</span><button class="btn bg bsm" onclick="goPage('applicants')">ì „ì²´ ë³´ê¸° â†’</button></div>
        <table><thead><tr><th>ì´ë¦„</th><th>ì§€ì› ì§ë¬´</th><th>ì¶œì²˜</th><th>ë‹¨ê³„</th><th>ë“±ë¡ì¼</th></tr></thead><tbody id="dash-tb"></tbody></table>
      </div>
    </div>

    <div class="page" id="page-applicants">
      <div class="fbar">
        <div class="sw"><span class="si">ğŸ”</span><input type="text" id="qs" placeholder="ì´ë¦„, ì§ë¬´, ë©”ëª¨ ê²€ìƒ‰..."></div>
        <select id="qsrc"><option value="">ì „ì²´ ì¶œì²˜</option><option>ì‚¬ëŒì¸</option><option>ì¡ì½”ë¦¬ì•„</option><option>PDFì´ë ¥ì„œ</option><option>ì§ì ‘ì…ë ¥</option></select>
        <select id="qjob"><option value="">ì „ì²´ ì§ë¬´</option></select>
      </div>
      <div class="chips" id="chips">
        <div class="chip active" data-st="">ì „ì²´</div>
        <div class="chip" data-st="ì„œë¥˜ê²€í† ">ğŸ“‹ ì„œë¥˜ê²€í† </div>
        <div class="chip" data-st="1ì°¨ë©´ì ‘">ğŸ¤ 1ì°¨ë©´ì ‘</div>
        <div class="chip" data-st="2ì°¨ë©´ì ‘">ğŸ¯ 2ì°¨ë©´ì ‘</div>
        <div class="chip" data-st="ìµœì¢…í•©ê²©">âœ… ìµœì¢…í•©ê²©</div>
        <div class="chip" data-st="ë¶ˆí•©ê²©">âŒ ë¶ˆí•©ê²©</div>
      </div>
      <div class="card">
        <div class="card-hd"><span class="card-t">ì§€ì›ì ëª©ë¡</span><span class="mu-c tsm" id="lcnt"></span></div>
        <table><thead><tr><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ì§€ì› ì§ë¬´</th><th>ì¶œì²˜</th><th>ë‹¨ê³„</th><th>ë“±ë¡ì¼</th><th style="width:120px">ì•¡ì…˜</th></tr></thead><tbody id="list-tb"></tbody></table>
      </div>
    </div>

    <div class="page" id="page-upload">
      <div class="api-warn" id="api-warn">
        âš ï¸ Gemini API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. <a onclick="goPage('settings')">ì„¤ì •ì—ì„œ ì…ë ¥</a>í•˜ë©´ AIê°€ PDFë¥¼ ìë™ìœ¼ë¡œ ì½ê³  ì •ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
      </div>
      <div class="upz" id="upz">
        <div class="up-ico">ğŸ“„</div>
        <h3>ì´ë ¥ì„œë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì—…ë¡œë“œ</h3>
        <p>PDF Â· HTML Â· TXT íŒŒì¼ ì§€ì›</p>
        <input type="file" id="fi" accept=".pdf,.html,.htm,.txt" style="display:none">
      </div>
      <div id="ai-progress" style="display:none">
        <div class="ai-status">
          <div class="ai-status-row"><div class="step-dot" id="step1-dot">1</div><div class="step-txt" id="step1-txt">íŒŒì¼ ì½ê¸°</div></div>
          <div class="ai-status-row"><div class="step-dot" id="step2-dot">2</div><div class="step-txt" id="step2-txt">AI ë¶„ì„ ì¤‘...</div></div>
          <div class="ai-status-row"><div class="step-dot" id="step3-dot">3</div><div class="step-txt" id="step3-txt">ì™„ë£Œ ëŒ€ê¸°</div></div>
        </div>
      </div>
      <div id="upres" style="display:none">
        <div class="pcard"><div class="pgrd" id="pgrd"></div></div>
        <div class="flex g2 mt4">
          <button class="btn bp" onclick="saveFromUpload()">ğŸ’¾ ì§€ì›ìë¡œ ì €ì¥</button>
          <button class="btn bg" onclick="resetUpload()">ğŸ”„ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>

    <div class="page" id="page-pipeline"><div class="board" id="board"></div></div>

    <div class="page" id="page-settings">
      <div class="sset">
        <h3>ğŸ¤– Gemini API ì„¤ì •</h3>
        <p>Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <div class="fg"><label>API Key</label><input type="password" id="cak"></div>
        <div class="fg"><label>ëª¨ë¸</label>
          <select id="cmod">
            <option value="gemini-1.5-flash">gemini-1.5-flash (ì¶”ì²œ)</option>
            <option value="gemini-2.0-flash-exp">gemini-2.0-flash (ìµœì‹ )</option>
            <option value="gemini-1.5-pro">gemini-1.5-pro (ê³ ì„±ëŠ¥)</option>
          </select>
        </div>
        <button class="btn bp" onclick="saveCfg()">ì €ì¥</button>
      </div>
      <div class="sset">
        <h3>ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>
        <button class="btn bg" onclick="exportJSON()">ğŸ“¤ JSON ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn bd-btn" onclick="clearAll()">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </div>

  </div>
</div>

<div class="overlay" id="modal-add">
  <div class="modal">
    <div class="mhd"><h2 id="add-ttl">ì§€ì›ì ì¶”ê°€</h2><button class="mcl" onclick="closeModal('modal-add')">Ã—</button></div>
    <input type="hidden" id="eid">
    <div class="frow">
      <div class="fg"><label>ì´ë¦„ *</label><input type="text" id="fn"></div>
      <div class="fg"><label>ì—°ë½ì²˜</label><input type="text" id="fph"></div>
      <div class="fg"><label>ì´ë©”ì¼</label><input type="text" id="fem"></div>
      <div class="fg"><label>ì§€ì› ì§ë¬´</label><input type="text" id="fj"></div>
      <div class="fg"><label>ì¶œì²˜</label><select id="fsrc"><option>ì§ì ‘ì…ë ¥</option><option>ì‚¬ëŒì¸</option><option>ì¡ì½”ë¦¬ì•„</option><option>PDFì´ë ¥ì„œ</option></select></div>
      <div class="fg"><label>ì±„ìš© ë‹¨ê³„</label><select id="fst"><option>ì„œë¥˜ê²€í† </option><option>1ì°¨ë©´ì ‘</option><option>2ì°¨ë©´ì ‘</option><option>ìµœì¢…í•©ê²©</option><option>ë¶ˆí•©ê²©</option></select></div>
    </div>
    <div class="fg"><label>ê²½ë ¥ ìš”ì•½</label><textarea id="fca" rows="5"></textarea></div>
    <div class="fg"><label>ë©”ëª¨</label><textarea id="fmo" rows="3"></textarea></div>
    <div class="mft"><button class="btn bp" onclick="saveApplicant()">ì €ì¥</button></div>
  </div>
</div>

<div class="overlay" id="modal-det">
  <div class="modal">
    <div class="mhd"><h2 id="det-name">ìƒì„¸</h2><button class="mcl" onclick="closeModal('modal-det')">Ã—</button></div>
    <div id="det-body"></div>
    <div class="mft">
      <button class="btn bd-btn bsm" id="det-del">ğŸ—‘ï¸ ì‚­ì œ</button>
      <button class="btn bp" id="det-edit">âœï¸ ìˆ˜ì •</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* â•â•â• STATE â•â•â• */
let DB = JSON.parse(localStorage.getItem('rma4') || '[]');
let CFG = JSON.parse(localStorage.getItem('rma4c') || '{"ak":"","m":"gemini-1.5-flash"}');
let upData = null; let detId = null; let stFilt = '';

/* â•â•â• PERSIST â•â•â• */
function save(){
  localStorage.setItem('rma4', JSON.stringify(DB));
  document.getElementById('nc').textContent = DB.length;
}

/* â•â•â• NAVIGATION â•â•â• */
document.querySelectorAll('.ni[data-pg]').forEach(el => {
  el.addEventListener('click', function(){ goPage(this.dataset.pg); });
});

function goPage(pg){
  document.querySelectorAll('.ni').forEach(n => n.classList.remove('active'));
  const nav = document.querySelector('.ni[data-pg="'+pg+'"]');
  if(nav) nav.classList.add('active');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+pg).classList.add('active');
  document.getElementById('ptitle').textContent = pg.toUpperCase();
  if(pg==='dashboard') renderDash();
  if(pg==='applicants') renderList();
  if(pg==='pipeline') renderPipe();
  if(pg==='upload') document.getElementById('api-warn').style.display = CFG.ak ? 'none' : 'block';
}

/* â•â•â• HELPERS â•â•â• */
const uid = () => Date.now().toString(36)+Math.random().toString(36).slice(2,5);
const fmtD = ts => new Date(ts).toLocaleDateString('ko-KR');
function badge(s){ return `<span class="badge b-${s}">${s}</span>`; }

/* â•â•â• DASHBOARD / LIST / PIPELINE â•â•â• */
function renderDash(){
  document.getElementById('s-total').textContent = DB.length;
  const recent = [...DB].sort((a,b)=>b.ts-a.ts).slice(0,5);
  document.getElementById('dash-tb').innerHTML = recent.map(a=>`<tr onclick="openDetail('${a.id}')"><td>${a.name}</td><td>${a.job}</td><td>${a.source}</td><td>${badge(a.stage)}</td><td>${fmtD(a.ts)}</td></tr>`).join('');
}

function renderList(){
  const q = document.getElementById('qs').value.toLowerCase();
  let list = DB.filter(a => a.name.toLowerCase().includes(q) || a.job.toLowerCase().includes(q));
  if(stFilt) list = list.filter(a => a.stage === stFilt);
  document.getElementById('list-tb').innerHTML = list.map(a => `<tr><td>${a.name}</td><td>${a.phone}</td><td>${a.job}</td><td>${a.source}</td><td>${badge(a.stage)}</td><td>${fmtD(a.ts)}</td><td><button onclick="openEdit('${a.id}')">ìˆ˜ì •</button></td></tr>`).join('');
}

function renderPipe(){
  const STAGES = ['ì„œë¥˜ê²€í† ','1ì°¨ë©´ì ‘','2ì°¨ë©´ì ‘','ìµœì¢…í•©ê²©','ë¶ˆí•©ê²©'];
  document.getElementById('board').innerHTML = STAGES.map(s => {
    const cards = DB.filter(a => a.stage === s);
    return `<div class="bcol"><div class="bcol-h">${s} (${cards.length})</div><div class="bcol-b">${cards.map(a=>`<div class="bcard" onclick="openDetail('${a.id}')">${a.name}<br><small>${a.job}</small></div>`).join('')}</div></div>`;
  }).join('');
}

/* â•â•â• MODAL CONTROL â•â•â• */
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

function openAddModal(){
  document.getElementById('eid').value = '';
  ['fn','fph','fem','fj','fca','fmo'].forEach(id=>document.getElementById(id).value='');
  openModal('modal-add');
}

function openEdit(id){
  const a = DB.find(x=>x.id===id); if(!a) return;
  document.getElementById('eid').value = id;
  document.getElementById('fn').value = a.name;
  document.getElementById('fph').value = a.phone;
  document.getElementById('fj').value = a.job;
  document.getElementById('fst').value = a.stage;
  document.getElementById('fca').value = a.career;
  openModal('modal-add');
}

function saveApplicant(){
  const id = document.getElementById('eid').value;
  const data = {
    id: id || uid(), ts: Date.now(),
    name: document.getElementById('fn').value,
    phone: document.getElementById('fph').value,
    email: document.getElementById('fem').value,
    job: document.getElementById('fj').value,
    source: document.getElementById('fsrc').value,
    stage: document.getElementById('fst').value,
    career: document.getElementById('fca').value,
    memo: document.getElementById('fmo').value,
  };
  if(id){ const idx=DB.findIndex(x=>x.id===id); DB[idx]=data; } else { DB.push(data); }
  save(); closeModal('modal-add'); renderDash(); renderList();
  toast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'ok');
}

/* â•â•â• AI UPLOAD (V1 ìµœì‹ ë²„ì „ ì ìš©) â•â•â• */
const fi = document.getElementById('fi');
document.getElementById('upz').onclick = () => fi.click();
fi.onchange = e => { if(e.target.files[0]) handleFile(e.target.files[0]); };

async function handleFile(file){
  document.getElementById('ai-progress').style.display = 'block';
  setStep(1,'ing');
  const b64 = await fileToBase64(file);
  setStep(1,'done'); setStep(2,'ing');
  try {
    const res = await callGeminiVision(b64, file.type || 'application/pdf');
    const parsed = JSON.parse(res.replace(/```json|```/g, ''));
    upData = { name: parsed.ì´ë¦„, phone: parsed.ì—°ë½ì²˜, job: parsed.ì§€ì›ì§ë¬´, career: parsed.ê²½ë ¥ìš”ì•½, source: 'PDFì´ë ¥ì„œ' };
    showParsedResult(upData);
    setStep(2,'done'); setStep(3,'done');
  } catch(e) {
    toast('AI ë¶„ì„ ì‹¤íŒ¨: ' + e.message, 'err');
  }
}

async function callGeminiVision(b64, mime){
  let modelId = CFG.m || 'gemini-1.5-flash';
  if(!modelId.startsWith('models/')) modelId = 'models/' + modelId;
  const url = `https://generativelanguage.googleapis.com/v1/${modelId}:generateContent?key=${CFG.ak}`;
  const prompt = `ì´ë ¥ì„œ ë¶„ì„ í›„ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µí•˜ì„¸ìš”: {"ì´ë¦„":"","ì—°ë½ì²˜":"","ì§€ì›ì§ë¬´":"","ê²½ë ¥ìš”ì•½":""}`;
  
  const resp = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ parts: [{ inline_data: { mime_type: mime, data: b64 } }, { text: prompt }] }],
      generationConfig: { response_mime_type: "application/json" }
    })
  });
  const data = await resp.json();
  if(data.error) throw new Error(data.error.message);
  return data.candidates[0].content.parts[0].text;
}

function showParsedResult(d){
  document.getElementById('pgrd').innerHTML = `<div><small>ì´ë¦„</small><div>${d.name}</div></div><div><small>ì§ë¬´</small><div>${d.job}</div></div>`;
  document.getElementById('upres').style.display = 'block';
}

function saveFromUpload(){
  DB.push({...upData, id: uid(), ts: Date.now(), stage: 'ì„œë¥˜ê²€í† ', memo: '', email: ''});
  save(); resetUpload(); goPage('applicants');
}

function resetUpload(){
  document.getElementById('upres').style.display = 'none';
  document.getElementById('ai-progress').style.display = 'none';
}

/* â•â•â• UTILS â•â•â• */
function setStep(n,s){ const d=document.getElementById('step'+n+'-dot'); d.className='step-dot '+s; d.textContent=s==='done'?'âœ“':n; }
function fileToBase64(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>res(e.target.result.split(',')[1]); r.readAsDataURL(f); }); }
function saveCfg(){ CFG.ak=document.getElementById('cak').value; CFG.m=document.getElementById('cmod').value; localStorage.setItem('rma4c', JSON.stringify(CFG)); toast('ì„¤ì • ì €ì¥','ok'); }
function toast(m,t){ const e=document.getElementById('toast'); e.textContent=m; e.className='show '+t; setTimeout(()=>e.className='',2000); }

/* â•â•â• INIT â•â•â• */
renderDash();
document.getElementById('nc').textContent = DB.length;
document.getElementById('cak').value = CFG.ak;
document.getElementById('cmod').value = CFG.m;
</script>
</body>
</html>
