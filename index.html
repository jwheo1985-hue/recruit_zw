
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì±„ìš© ê´€ë¦¬ ì—ì´ì „íŠ¸</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=DM+Mono:wght@400;500&display=swap');

:root {
  --bg: #f5f3ef;
  --surface: #ffffff;
  --surface2: #f0ede8;
  --border: #e2ddd6;
  --ink: #1a1714;
  --ink-muted: #8a8076;
  --accent: #c94f2a;
  --accent2: #2a6cc9;
  --accent3: #2ac978;
  --accent4: #c9a72a;
  --shadow: rgba(26,23,20,0.08);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Noto Sans KR', sans-serif;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
}

header {
  background: var(--ink);
  color: white;
  padding: 0 28px;
  height: 58px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 900;
  font-size: 15px;
  letter-spacing: -0.5px;
}

.logo-dot {
  width: 10px; height: 10px;
  background: var(--accent);
  border-radius: 50%;
}

.header-stats {
  display: flex;
  gap: 20px;
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  color: rgba(255,255,255,0.5);
}

.header-stat span { color: white; font-weight: 500; }

.app {
  display: grid;
  grid-template-columns: 200px 1fr;
  min-height: calc(100vh - 58px);
}

/* Sidebar */
.sidebar {
  background: var(--ink);
  padding: 20px 0;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 11px 20px;
  cursor: pointer;
  font-size: 13px;
  color: rgba(255,255,255,0.45);
  border-left: 3px solid transparent;
  transition: all 0.15s;
}

.nav-item:hover { color: rgba(255,255,255,0.8); background: rgba(255,255,255,0.05); }
.nav-item.active { color: white; border-left-color: var(--accent); background: rgba(255,255,255,0.07); }
.nav-icon { font-size: 15px; }

.nav-section-label {
  padding: 14px 20px 5px;
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 2px;
  color: rgba(255,255,255,0.2);
  text-transform: uppercase;
}

.nav-badge {
  margin-left: auto;
  background: var(--accent);
  color: white;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 10px;
  font-family: 'DM Mono', monospace;
}

/* Main */
.main { overflow-y: auto; padding: 28px; display: none; }
.main.active { display: block; }

.page-title {
  font-size: 24px;
  font-weight: 900;
  letter-spacing: -1px;
  margin-bottom: 4px;
}

.page-sub {
  color: var(--ink-muted);
  font-size: 13px;
  margin-bottom: 24px;
}

/* Cards */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px var(--shadow);
}

.card-title {
  font-size: 13px;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }

/* Stat cards */
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px 18px;
  box-shadow: 0 2px 8px var(--shadow);
}

.stat-label { font-size: 11px; color: var(--ink-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
.stat-value { font-family: 'DM Mono', monospace; font-size: 28px; font-weight: 500; color: var(--ink); }
.stat-note { font-size: 11px; color: var(--ink-muted); margin-top: 4px; }

/* Status badges */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
}

.status-pending { background: #fef3e2; color: #c9a72a; }
.status-review { background: #e8f0fe; color: #2a6cc9; }
.status-pass { background: #e6f9f0; color: #2ac978; }
.status-fail { background: #fce8e8; color: #c94f2a; }
.status-hold { background: #f0ede8; color: #8a8076; }

/* Upload zone */
.upload-zone {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 48px 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--surface2);
}

.upload-zone:hover, .upload-zone.drag-over {
  border-color: var(--accent);
  background: rgba(201,79,42,0.04);
}

.upload-icon { font-size: 48px; margin-bottom: 12px; }
.upload-title { font-weight: 700; font-size: 15px; margin-bottom: 6px; }
.upload-sub { font-size: 12px; color: var(--ink-muted); }

/* Form */
.form-group { margin-bottom: 13px; }

label {
  display: block;
  font-size: 11px;
  font-weight: 700;
  color: var(--ink-muted);
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

input, select, textarea {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 9px 12px;
  color: var(--ink);
  font-family: 'Noto Sans KR', sans-serif;
  font-size: 13px;
  outline: none;
  transition: border-color 0.2s;
}

input:focus, select:focus, textarea:focus { border-color: var(--accent); background: white; }
select option { background: white; }

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 9px 16px;
  border-radius: 8px;
  border: none;
  font-family: 'Noto Sans KR', sans-serif;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary { background: var(--ink); color: white; }
.btn-primary:hover { background: #333; transform: translateY(-1px); }
.btn-accent { background: var(--accent); color: white; }
.btn-accent:hover { background: #b03d1e; transform: translateY(-1px); }
.btn-secondary { background: var(--surface2); color: var(--ink); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--ink); }
.btn-success { background: var(--accent3); color: white; }
.btn-danger { background: var(--accent); color: white; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

/* Table */
.recruit-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.recruit-table th {
  background: var(--surface2);
  padding: 10px 14px;
  text-align: left;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--ink-muted);
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

.recruit-table td {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}

.recruit-table tr:hover td { background: var(--surface2); }
.recruit-table tr:last-child td { border-bottom: none; }

/* Candidate card */
.candidate-name { font-weight: 700; font-size: 14px; }
.candidate-meta { font-size: 11px; color: var(--ink-muted); margin-top: 2px; }

/* AI chat */
.chat-messages {
  min-height: 200px;
  max-height: 400px;
  overflow-y: auto;
  padding: 12px 0;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.msg { max-width: 85%; padding: 10px 14px; border-radius: 10px; font-size: 13px; line-height: 1.6; }
.msg-user { background: var(--ink); color: white; align-self: flex-end; border-bottom-right-radius: 3px; }
.msg-ai { background: var(--surface2); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 3px; }

.chat-input-area { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--border); margin-top: 12px; }
.chat-input { flex: 1; resize: none; padding: 10px 12px; font-size: 13px; }

/* Loading */
.loading { display: inline-flex; gap: 4px; align-items: center; }
.loading span { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: bounce 1.2s infinite; }
.loading span:nth-child(2) { animation-delay: 0.2s; }
.loading span:nth-child(3) { animation-delay: 0.4s; }
@keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }

/* Modal */
.modal-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  align-items: center;
  justify-content: center;
}

.modal-overlay.open { display: flex; }

.modal {
  background: white;
  border-radius: 16px;
  padding: 28px;
  width: 560px;
  max-width: 95vw;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}

.modal-title { font-size: 18px; font-weight: 900; margin-bottom: 20px; letter-spacing: -0.5px; }
.modal-close { float: right; cursor: pointer; font-size: 20px; color: var(--ink-muted); background: none; border: none; }

/* Progress bar */
.progress-bar {
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
  margin-top: 8px;
}

.progress-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 3px;
  transition: width 0.5s;
}

/* Tabs */
.tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 20px;
  background: var(--surface2);
  padding: 4px;
  border-radius: 10px;
  width: fit-content;
  border: 1px solid var(--border);
}

.tab {
  padding: 7px 16px;
  border-radius: 7px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  color: var(--ink-muted);
  transition: all 0.2s;
}

.tab.active { background: var(--ink); color: white; font-weight: 700; }

/* Filter bar */
.filter-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
  align-items: center;
}

.filter-bar input, .filter-bar select {
  width: auto;
  padding: 7px 12px;
  font-size: 12px;
}

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-dot"></div>
    ì±„ìš© ê´€ë¦¬ ì—ì´ì „íŠ¸
  </div>
  <div class="header-stats">
    ì´ ì§€ì›ì <span id="hTotal">0</span>ëª… &nbsp;|&nbsp;
    ê²€í† ì¤‘ <span id="hReview">0</span>ëª… &nbsp;|&nbsp;
    í•©ê²© <span id="hPass">0</span>ëª…
  </div>
</header>

<div class="app">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="nav-section-label">ë©”ì¸</div>
    <div class="nav-item active" data-page="dashboard">
      <span class="nav-icon">ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ
    </div>
    <div class="nav-section-label">ì±„ìš©</div>
    <div class="nav-item" data-page="upload">
      <span class="nav-icon">ğŸ“„</span> ì´ë ¥ì„œ ì—…ë¡œë“œ
    </div>
    <div class="nav-item" data-page="candidates">
      <span class="nav-icon">ğŸ‘¥</span> ì§€ì›ì ê´€ë¦¬
      <span class="nav-badge" id="navBadge">0</span>
    </div>
    <div class="nav-section-label">ë¶„ì„</div>
    <div class="nav-item" data-page="analysis">
      <span class="nav-icon">ğŸ“ˆ</span> ì§€ì› í˜„í™© ë¶„ì„
    </div>
    <div class="nav-item" data-page="email">
      <span class="nav-icon">âœ‰ï¸</span> ì´ë©”ì¼ ë°œì†¡
    </div>
    <div class="nav-item" data-page="chat">
      <span class="nav-icon">ğŸ¤–</span> AI ìƒë‹´
    </div>
  </nav>

  <!-- Dashboard -->
  <div class="main active" id="page-dashboard">
    <div class="page-title">ì±„ìš© í˜„í™©</div>
    <div class="page-sub" id="dashDate"></div>

    <div class="grid-4" style="margin-bottom:20px;">
      <div class="stat-card">
        <div class="stat-label">ì´ ì§€ì›ì</div>
        <div class="stat-value" id="statTotal">0</div>
        <div class="stat-note">ì „ì²´ ì ‘ìˆ˜</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ê²€í†  ì¤‘</div>
        <div class="stat-value" style="color:var(--accent2)" id="statReview">0</div>
        <div class="stat-note">ì„œë¥˜ ê²€í† </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">í•©ê²©ì</div>
        <div class="stat-value" style="color:var(--accent3)" id="statPass">0</div>
        <div class="stat-note">ìµœì¢… í•©ê²©</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ë¶ˆí•©ê²©</div>
        <div class="stat-value" style="color:var(--accent)" id="statFail">0</div>
        <div class="stat-note">ì„œë¥˜/ë©´ì ‘</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-title">ğŸ• ìµœê·¼ ë“±ë¡ ì§€ì›ì</div>
        <div id="recentCandidates">
          <div style="text-align:center; padding:30px 0; color:var(--ink-muted); font-size:13px;">
            ì´ë ¥ì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
          </div>
        </div>
        <div style="margin-top:12px;">
          <button class="btn btn-secondary" onclick="navigate('upload')">+ ì´ë ¥ì„œ ì—…ë¡œë“œ</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“Œ ì§€ì› ë¶„ì•¼ë³„ í˜„í™©</div>
        <div id="positionStats">
          <div style="text-align:center; padding:30px 0; color:var(--ink-muted); font-size:13px;">
            ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">âš¡ ë¹ ë¥¸ ì‹¤í–‰</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-accent" onclick="navigate('upload')">ğŸ“„ ì´ë ¥ì„œ ì—…ë¡œë“œ</button>
        <button class="btn btn-primary" onclick="navigate('candidates')">ğŸ‘¥ ì§€ì›ì ëª©ë¡ ë³´ê¸°</button>
        <button class="btn btn-secondary" onclick="exportToExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-secondary" onclick="navigate('chat')">ğŸ¤– AI ìƒë‹´</button>
      </div>
    </div>
  </div>

  <!-- Upload -->
  <div class="main" id="page-upload">
    <div class="page-title">ì´ë ¥ì„œ ì—…ë¡œë“œ</div>
    <div class="page-sub">ì‚¬ëŒì¸Â·ì¡ì½”ë¦¬ì•„ ë“±ì—ì„œ ë‹¤ìš´ë°›ì€ PDF ì´ë ¥ì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ AIê°€ ìë™ìœ¼ë¡œ ì •ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤</div>

    <!-- Gemini API í‚¤ ì„¤ì • -->
    <div class="card" style="border:2px solid var(--accent4); background:#fffbf0;">
      <div class="card-title">ğŸ”‘ Gemini API í‚¤ ì„¤ì • <span style="font-size:11px; font-weight:400; color:var(--ink-muted);">â€” ìµœì´ˆ 1íšŒë§Œ ì…ë ¥ (ë¬´ë£Œ)</span></div>
      <div style="display:flex; gap:10px; align-items:flex-end;">
        <div class="form-group" style="flex:1; margin-bottom:0;">
          <label>Gemini API Key</label>
          <input type="password" id="geminiApiKey" placeholder="AIza...">
        </div>
        <button class="btn btn-primary" onclick="saveGeminiKey()">ğŸ’¾ ì €ì¥</button>
      </div>
      <div style="margin-top:8px; font-size:12px; color:var(--ink-muted);">
        ë¬´ë£Œ ë°œê¸‰: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--accent2);">aistudio.google.com</a> ì ‘ì† â†’ ë¡œê·¸ì¸ â†’ <strong>Get API Key</strong> â†’ <strong>Create API Key</strong> â†’ ë³µì‚¬
      </div>
      <div id="geminiKeyStatus" style="margin-top:6px; font-size:12px;"></div>
    </div>

    <div class="card">
      <div class="card-title">ğŸ“„ PDF ì´ë ¥ì„œ ì—…ë¡œë“œ</div>
      <!-- ì§ì ‘ ë³´ì´ëŠ” ë²„íŠ¼ ë°©ì‹ìœ¼ë¡œ ë³€ê²½ -->
      <div style="margin-bottom:14px;">
        <label for="pdfInput" style="display:inline-flex; align-items:center; gap:8px; padding:12px 20px; background:var(--accent); color:white; border-radius:8px; cursor:pointer; font-weight:700; font-size:14px; text-transform:none; letter-spacing:0;">
          ğŸ“‚ ì»´í“¨í„°ì—ì„œ PDF íŒŒì¼ ì„ íƒ
        </label>
        <input type="file" id="pdfInput" accept=".pdf" multiple style="display:none;" onchange="handlePDFUpload(event)">
        <span style="margin-left:12px; font-size:12px; color:var(--ink-muted);">ì—¬ëŸ¬ íŒŒì¼ ë™ì‹œ ì„ íƒ ê°€ëŠ¥</span>
      </div>
      <div class="upload-zone" id="uploadZone">
        <div class="upload-icon">ğŸ“‹</div>
        <div class="upload-title">ë˜ëŠ” ì—¬ê¸°ì— PDFë¥¼ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</div>
        <div class="upload-sub">ì‚¬ëŒì¸ Â· ì¡ì½”ë¦¬ì•„ Â· ì›í‹°ë“œ ë“± PDF ì´ë ¥ì„œ ì§€ì›</div>
      </div>
    </div>

    <!-- ì—…ë¡œë“œ ì§„í–‰ ìƒí™© -->
    <div class="card" id="uploadProgress" style="display:none;">
      <div class="card-title">âš™ï¸ AI ì •ë³´ ì¶”ì¶œ ì¤‘...</div>
      <div id="progressList"></div>
    </div>

    <!-- ì¶”ì¶œ ê²°ê³¼ í™•ì¸/ìˆ˜ì • -->
    <div class="card" id="extractedResult" style="display:none;">
      <div class="card-title">âœ… ì¶”ì¶œ ì™„ë£Œ â€” ì •ë³´ í™•ì¸ ë° ìˆ˜ì •</div>
      <div id="extractedForms"></div>
      <div style="margin-top:16px; display:flex; gap:10px;">
        <button class="btn btn-accent" onclick="saveAllCandidates()">ğŸ’¾ ì „ì²´ ì €ì¥</button>
        <button class="btn btn-secondary" onclick="resetUpload()">ğŸ”„ ë‹¤ì‹œ ì—…ë¡œë“œ</button>
      </div>
    </div>
  </div>

  <!-- Candidates List -->
  <div class="main" id="page-candidates">
    <div class="page-title">ì§€ì›ì ê´€ë¦¬</div>
    <div class="page-sub">ë“±ë¡ëœ ì§€ì›ì ëª©ë¡ Â· í•©ê²© ì—¬ë¶€ ê´€ë¦¬ Â· ë©”ëª¨ ì¶”ê°€</div>

    <div class="filter-bar">
      <input type="text" id="searchInput" placeholder="ğŸ” ì´ë¦„, ì§€ì›ë¶„ì•¼ ê²€ìƒ‰..." style="width:200px;" oninput="renderCandidateTable()">
      <select id="filterStatus" onchange="renderCandidateTable()" style="width:120px;">
        <option value="">ì „ì²´ ìƒíƒœ</option>
        <option value="pending">ê²€í†  ëŒ€ê¸°</option>
        <option value="review">ê²€í†  ì¤‘</option>
        <option value="pass">í•©ê²©</option>
        <option value="fail">ë¶ˆí•©ê²©</option>
        <option value="hold">ë³´ë¥˜</option>
      </select>
      <select id="filterPosition" onchange="renderCandidateTable()" style="width:140px;">
        <option value="">ì „ì²´ ì§€ì›ë¶„ì•¼</option>
      </select>
      <button class="btn btn-secondary" onclick="exportToExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      <button class="btn btn-accent" onclick="navigate('upload')" style="margin-left:auto;">+ ì´ë ¥ì„œ ì—…ë¡œë“œ</button>
    </div>

    <div class="card" style="padding:0; overflow:hidden;">
      <div style="overflow-x:auto;">
        <table class="recruit-table" id="candidateTable">
          <thead>
            <tr>
              <th>ì´ë¦„</th>
              <th>ì§€ì›ë¶„ì•¼</th>
              <th>ë‚˜ì´</th>
              <th>í•™ë ¥</th>
              <th>ê²½ë ¥</th>
              <th>ì—°ë½ì²˜</th>
              <th>ìƒíƒœ</th>
              <th>ë“±ë¡ì¼</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="candidateTableBody">
            <tr><td colspan="9" style="text-align:center; padding:40px; color:var(--ink-muted);">ë“±ë¡ëœ ì§€ì›ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Analysis -->
  <div class="main" id="page-analysis">
    <div class="page-title">ì§€ì› í˜„í™© ë¶„ì„</div>
    <div class="page-sub">ì§€ì›ì ë°ì´í„° í†µê³„ ë° AI ë¶„ì„</div>

    <div class="grid-2">
      <div class="card">
        <div class="card-title">ğŸ“Š ìƒíƒœë³„ ë¶„í¬</div>
        <div id="statusChart"></div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ¯ ì§€ì›ë¶„ì•¼ë³„ ì¸ì›</div>
        <div id="positionChart"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">ğŸ¤– AI ì±„ìš© ë¶„ì„ ë¦¬í¬íŠ¸</div>
      <div style="margin-bottom:12px;">
        <button class="btn btn-accent" onclick="generateAnalysisReport()">ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„±</button>
      </div>
      <div id="analysisReport" style="display:none; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:16px; font-size:13px; line-height:1.8; white-space:pre-wrap;"></div>
    </div>
  </div>

  <!-- Email Page -->
  <div class="main" id="page-email">
    <div class="page-title">ì´ë©”ì¼ ë°œì†¡</div>
    <div class="page-sub">ì§€ì›ìì—ê²Œ í•©ê²©Â·ë¶ˆí•©ê²©Â·ë©´ì ‘ ì•ˆë‚´ ì´ë©”ì¼ì„ ìë™ìœ¼ë¡œ ë°œì†¡í•©ë‹ˆë‹¤</div>

    <!-- EmailJS ì„¤ì • -->
    <div class="card" style="border:2px solid var(--accent4); background:#fffbf0;">
      <div class="card-title">âš™ï¸ EmailJS ì„¤ì • <span style="font-size:11px; font-weight:400; color:var(--ink-muted);">â€” ìµœì´ˆ 1íšŒë§Œ ì…ë ¥í•˜ì„¸ìš”</span></div>
      <div class="grid-3" style="gap:10px; margin-bottom:10px;">
        <div class="form-group" style="margin-bottom:0;">
          <label>Service ID</label>
          <input type="text" id="ejsServiceId" placeholder="service_xxxxxxx">
        </div>
        <div class="form-group" style="margin-bottom:0;">
          <label>Template ID</label>
          <input type="text" id="ejsTemplateId" placeholder="template_xxxxxxx">
        </div>
        <div class="form-group" style="margin-bottom:0;">
          <label>Public Key</label>
          <input type="text" id="ejsPublicKey" placeholder="xxxxxxxxxxxxxx">
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn btn-primary" onclick="saveEmailJSConfig()">ğŸ’¾ ì €ì¥</button>
        <span style="font-size:12px; color:var(--ink-muted);">
          <a href="https://emailjs.com" target="_blank" style="color:var(--accent2);">emailjs.com</a> ê°€ì… â†’ Email Services â†’ Email Templates â†’ Account â†’ Public Key
        </span>
      </div>
      <div id="ejsConfigStatus" style="margin-top:8px; font-size:12px;"></div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchEmailTab(this, 'email-template')">ğŸ“ í…œí”Œë¦¿ ë°œì†¡</div>
      <div class="tab" onclick="switchEmailTab(this, 'email-bulk')">ğŸ“¨ ì¼ê´„ ë°œì†¡</div>
      <div class="tab" onclick="switchEmailTab(this, 'email-log')">ğŸ“‹ ë°œì†¡ ê¸°ë¡</div>
    </div>

    <!-- í…œí”Œë¦¿ ë°œì†¡ -->
    <div id="email-template">
      <div class="grid-2">
        <div class="card">
          <div class="card-title">âœ‰ï¸ ì´ë©”ì¼ ì‘ì„±</div>

          <div class="form-group">
            <label>ì´ë©”ì¼ ìœ í˜•</label>
            <select id="emailType" onchange="loadEmailTemplate()">
              <option value="pass">âœ… í•©ê²© ì•ˆë‚´</option>
              <option value="fail">âŒ ë¶ˆí•©ê²© ì•ˆë‚´</option>
              <option value="interview">ğŸ“… ë©´ì ‘ ì•ˆë‚´</option>
              <option value="document">ğŸ“‹ ì„œë¥˜ ì ‘ìˆ˜ í™•ì¸</option>
              <option value="custom">âœï¸ ì§ì ‘ ì‘ì„±</option>
            </select>
          </div>

          <div class="form-group">
            <label>ìˆ˜ì‹ ì ì„ íƒ</label>
            <select id="emailRecipient">
              <option value="">â€” ì§€ì›ì ì„ íƒ â€”</option>
            </select>
          </div>

          <div class="form-group">
            <label>ìˆ˜ì‹  ì´ë©”ì¼ ì£¼ì†Œ</label>
            <input type="email" id="emailTo" placeholder="ìë™ ì…ë ¥ë©ë‹ˆë‹¤">
          </div>

          <div class="form-group">
            <label>ì œëª©</label>
            <input type="text" id="emailSubject">
          </div>

          <div class="form-group">
            <label>ë³¸ë¬¸</label>
            <textarea id="emailBody" rows="8"></textarea>
          </div>

          <div style="display:flex; gap:8px;">
            <button class="btn btn-accent" onclick="sendEmail()">âœ‰ï¸ ì´ë©”ì¼ ë°œì†¡</button>
            <button class="btn btn-secondary" onclick="aiWriteEmail()">ğŸ¤– AI ì‘ì„±</button>
            <button class="btn btn-secondary" onclick="loadEmailTemplate()">ğŸ”„ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>
          <div id="emailSendStatus" style="margin-top:10px; font-size:13px;"></div>
        </div>

        <div class="card">
          <div class="card-title">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</div>
          <div id="emailPreview" style="background:white; border:1px solid var(--border); border-radius:8px; padding:20px; min-height:300px;">
            <div style="color:var(--ink-muted); text-align:center; padding:60px 0; font-size:13px;">
              ì´ë©”ì¼ì„ ì‘ì„±í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ì¼ê´„ ë°œì†¡ -->
    <div id="email-bulk" style="display:none;">
      <div class="card">
        <div class="card-title">ğŸ“¨ ìƒíƒœë³„ ì¼ê´„ ì´ë©”ì¼ ë°œì†¡</div>
        <div style="background:rgba(201,79,42,0.08); border:1px solid rgba(201,79,42,0.2); border-radius:8px; padding:12px; margin-bottom:16px; font-size:13px; color:var(--accent);">
          âš ï¸ ì¼ê´„ ë°œì†¡ ì „ EmailJS ì„¤ì •ì´ ì™„ë£Œë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ì›” 200ê±´ ë¬´ë£Œ í•œë„ë¥¼ í™•ì¸í•˜ì„¸ìš”.
        </div>
        <div class="form-group">
          <label>ë°œì†¡ ëŒ€ìƒ</label>
          <select id="bulkTarget">
            <option value="pass">âœ… í•©ê²©ì ì „ì²´</option>
            <option value="fail">âŒ ë¶ˆí•©ê²©ì ì „ì²´</option>
            <option value="review">ğŸ” ê²€í† ì¤‘ ì „ì²´</option>
            <option value="all">ğŸ‘¥ ì „ì²´ ì§€ì›ì</option>
          </select>
        </div>
        <div class="form-group">
          <label>ì´ë©”ì¼ ìœ í˜•</label>
          <select id="bulkEmailType" onchange="loadBulkTemplate()">
            <option value="pass">í•©ê²© ì•ˆë‚´</option>
            <option value="fail">ë¶ˆí•©ê²© ì•ˆë‚´</option>
            <option value="interview">ë©´ì ‘ ì•ˆë‚´</option>
          </select>
        </div>
        <div class="form-group">
          <label>ì œëª©</label>
          <input type="text" id="bulkSubject">
        </div>
        <div class="form-group">
          <label>ë³¸ë¬¸ <span style="font-weight:400; color:var(--ink-muted);">({ì´ë¦„} ì€ ìë™ìœ¼ë¡œ ì§€ì›ì ì´ë¦„ìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤)</span></label>
          <textarea id="bulkBody" rows="6"></textarea>
        </div>
        <div id="bulkPreviewList" style="margin-bottom:12px;"></div>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-secondary" onclick="previewBulkRecipients()">ğŸ‘¥ ë°œì†¡ ëŒ€ìƒ í™•ì¸</button>
          <button class="btn btn-accent" onclick="sendBulkEmail()">ğŸ“¨ ì¼ê´„ ë°œì†¡ ì‹œì‘</button>
        </div>
        <div id="bulkSendStatus" style="margin-top:12px; font-size:13px;"></div>
      </div>
    </div>

    <!-- ë°œì†¡ ê¸°ë¡ -->
    <div id="email-log" style="display:none;">
      <div class="card">
        <div class="card-title">ğŸ“‹ ì´ë©”ì¼ ë°œì†¡ ê¸°ë¡</div>
        <div style="display:flex; justify-content:flex-end; margin-bottom:12px;">
          <button class="btn btn-secondary" onclick="clearEmailLog()">ğŸ—‘ï¸ ê¸°ë¡ ì‚­ì œ</button>
        </div>
        <div id="emailLogContent"></div>
      </div>
    </div>
  </div>

  <!-- AI Chat -->
  <div class="main" id="page-chat">
    <div class="page-title">AI ì±„ìš© ìƒë‹´</div>
    <div class="page-sub">ì§€ì›ì ê´€ë ¨ ì§ˆë¬¸, ë©´ì ‘ ì§ˆë¬¸ ì¶”ì²œ, í‰ê°€ ê¸°ì¤€ ë“±ì„ AIì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”</div>

    <div class="card" style="height:calc(100vh - 200px); display:flex; flex-direction:column;">
      <div class="chat-messages" id="chatMessages">
        <div class="msg msg-ai">
          ì•ˆë…•í•˜ì„¸ìš”! ì±„ìš© ê´€ë¦¬ AI ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤. ğŸ¤–<br><br>
          ë‹¤ìŒê³¼ ê°™ì€ ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”:<br>
          â€¢ ì§€ì›ì í‰ê°€ ê¸°ì¤€ ì œì•ˆ<br>
          â€¢ ì§ë¬´ë³„ ë©´ì ‘ ì§ˆë¬¸ ì¶”ì²œ<br>
          â€¢ ì´ë ¥ì„œ ë¶„ì„ ë° ê²€í†  í¬ì¸íŠ¸<br>
          â€¢ ì±„ìš© ê³µê³  ì‘ì„± ë„ì›€<br>
          â€¢ í•©ê²©/ë¶ˆí•©ê²© íŒë‹¨ ê¸°ì¤€ ìƒë‹´<br><br>
          ë¬´ì—‡ì´ë“  ì§ˆë¬¸í•´ ì£¼ì„¸ìš”!
        </div>
      </div>
      <div class="chat-input-area">
        <textarea class="chat-input" id="chatInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: ê°œë°œì ë©´ì ‘ ì§ˆë¬¸ ì¶”ì²œí•´ì¤˜)" rows="2"></textarea>
        <button class="btn btn-accent" onclick="sendChat()">ì „ì†¡</button>
      </div>
    </div>
  </div>
</div>

<!-- ì§€ì›ì ìƒì„¸/ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal-overlay" id="candidateModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">âœ•</button>
    <div class="modal-title" id="modalTitle">ì§€ì›ì ì •ë³´</div>
    <div id="modalContent"></div>
  </div>
</div>

<script>
// â”€â”€ ë°ì´í„° ì €ì¥ì†Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let candidates = JSON.parse(localStorage.getItem('recruitCandidates') || '[]');
let extractedQueue = [];

// â”€â”€ ë‚ ì§œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const now = new Date();
document.getElementById('dashDate').textContent =
  now.toLocaleDateString('ko-KR', {year:'numeric', month:'long', day:'numeric', weekday:'long'});

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navigate(page) {
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.main').forEach(el => el.classList.remove('active'));
  document.querySelector(`[data-page="${page}"]`).classList.add('active');
  document.getElementById(`page-${page}`).classList.add('active');
  if (page === 'candidates') renderCandidateTable();
  if (page === 'dashboard') renderDashboard();
  if (page === 'analysis') renderAnalysis();
}

document.querySelectorAll('.nav-item').forEach(el => {
  el.addEventListener('click', () => navigate(el.dataset.page));
});

// â”€â”€ í†µê³„ ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  const total = candidates.length;
  const review = candidates.filter(c => c.status === 'review').length;
  const pass = candidates.filter(c => c.status === 'pass').length;
  const fail = candidates.filter(c => c.status === 'fail').length;
  const pending = candidates.filter(c => c.status === 'pending').length;

  document.getElementById('statTotal').textContent = total;
  document.getElementById('statReview').textContent = review + pending;
  document.getElementById('statPass').textContent = pass;
  document.getElementById('statFail').textContent = fail;
  document.getElementById('hTotal').textContent = total;
  document.getElementById('hReview').textContent = review + pending;
  document.getElementById('hPass').textContent = pass;
  document.getElementById('navBadge').textContent = total;
}

// â”€â”€ ëŒ€ì‹œë³´ë“œ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard() {
  updateStats();

  // ìµœê·¼ ì§€ì›ì
  const recent = [...candidates].reverse().slice(0, 5);
  const recentEl = document.getElementById('recentCandidates');
  if (recent.length === 0) {
    recentEl.innerHTML = '<div style="text-align:center; padding:30px 0; color:var(--ink-muted); font-size:13px;">ì´ë ¥ì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';
  } else {
    recentEl.innerHTML = recent.map(c => `
      <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border);" onclick="openCandidateModal(${c.id})" style="cursor:pointer;">
        <div>
          <div style="font-weight:700; font-size:13px;">${c.name}</div>
          <div style="font-size:11px; color:var(--ink-muted);">${c.position} Â· ${c.age}ì„¸</div>
        </div>
        ${statusBadge(c.status)}
      </div>`).join('');
  }

  // ì§€ì›ë¶„ì•¼ë³„ í†µê³„
  const posMap = {};
  candidates.forEach(c => { posMap[c.position] = (posMap[c.position] || 0) + 1; });
  const posEl = document.getElementById('positionStats');
  if (Object.keys(posMap).length === 0) {
    posEl.innerHTML = '<div style="text-align:center; padding:30px 0; color:var(--ink-muted); font-size:13px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
  } else {
    const max = Math.max(...Object.values(posMap));
    posEl.innerHTML = Object.entries(posMap).map(([pos, cnt]) => `
      <div style="margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
          <span style="font-weight:600;">${pos}</span>
          <span style="color:var(--ink-muted);">${cnt}ëª…</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" style="width:${(cnt/max*100).toFixed(0)}%"></div></div>
      </div>`).join('');
  }
}

// â”€â”€ Gemini API í‚¤ ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveGeminiKey() {
  const key = document.getElementById('geminiApiKey').value.trim();
  if (!key) { alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  localStorage.setItem('geminiApiKey', key);
  const el = document.getElementById('geminiKeyStatus');
  el.textContent = 'âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
  el.style.color = 'var(--accent3)';
  setTimeout(() => el.textContent = '', 3000);
}

function loadGeminiKey() {
  const key = localStorage.getItem('geminiApiKey') || '';
  const el = document.getElementById('geminiApiKey');
  if (el && key) {
    el.value = key;
    document.getElementById('geminiKeyStatus').textContent = 'âœ… ì €ì¥ëœ í‚¤ê°€ ìˆìŠµë‹ˆë‹¤';
    document.getElementById('geminiKeyStatus').style.color = 'var(--accent3)';
  }
}

// â”€â”€ PDF ì—…ë¡œë“œ ì²˜ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault();
  uploadZone.classList.remove('drag-over');
  const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
  if (files.length) processFiles(files);
});

function handlePDFUpload(event) {
  const files = Array.from(event.target.files);
  if (files.length) processFiles(files);
}

async function processFiles(files) {
  const apiKey = localStorage.getItem('geminiApiKey');
  if (!apiKey) {
    alert('ë¨¼ì € Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”!\n\në¬´ë£Œ ë°œê¸‰: aistudio.google.com â†’ Get API Key');
    return;
  }

  extractedQueue = [];
  document.getElementById('uploadProgress').style.display = 'block';
  document.getElementById('extractedResult').style.display = 'none';

  const progressList = document.getElementById('progressList');
  progressList.innerHTML = files.map((f, i) => `
    <div style="display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid var(--border);">
      <div style="font-size:20px;">ğŸ“„</div>
      <div style="flex:1;">
        <div style="font-weight:600; font-size:13px;">${f.name}</div>
        <div id="prog-status-${i}" style="font-size:11px; color:var(--ink-muted);">ëŒ€ê¸° ì¤‘...</div>
        <div class="progress-bar" style="margin-top:4px;"><div class="progress-fill" id="prog-bar-${i}" style="width:0%"></div></div>
      </div>
    </div>`).join('');

  for (let i = 0; i < files.length; i++) {
    await processOnePDF(files[i], i);
  }
  renderExtractedForms();
}

async function processOnePDF(file, idx) {
  const statusEl = document.getElementById(`prog-status-${idx}`);
  const barEl = document.getElementById(`prog-bar-${idx}`);
  const apiKey = localStorage.getItem('geminiApiKey');

  statusEl.textContent = 'PDF ì½ëŠ” ì¤‘...';
  barEl.style.width = '20%';

  const base64 = await fileToBase64(file);

  statusEl.innerHTML = '<div class="loading"><span></span><span></span><span></span></div> Gemini AI ë¶„ì„ ì¤‘...';
  barEl.style.width = '60%';

  const prompt = `ì´ ì´ë ¥ì„œ PDFì—ì„œ ë‹¤ìŒ ì •ë³´ë¥¼ ì¶”ì¶œí•´ì„œ ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.

{
  "name": "ì´ë¦„",
  "age": ë‚˜ì´(ìˆ«ì, ëª¨ë¥´ë©´ 0),
  "gender": "ì„±ë³„(ë‚¨/ì—¬/ë¯¸ìƒ)",
  "phone": "ì—°ë½ì²˜",
  "email": "ì´ë©”ì¼",
  "address": "ì£¼ì†Œ(ì‹œ/ë„ ìˆ˜ì¤€)",
  "education": "ìµœì¢…í•™ë ¥(ê³ ì¡¸/ì „ë¬¸ëŒ€ì¡¸/ëŒ€ì¡¸/ëŒ€í•™ì›ì¡¸)",
  "school": "í•™êµëª…",
  "major": "ì „ê³µ",
  "experience_years": ê²½ë ¥ë…„ìˆ˜(ìˆ«ì, ì‹ ì…ì´ë©´ 0),
  "position": "ì§€ì›ë¶„ì•¼(ì´ë ¥ì„œì—ì„œ íŒŒì•…)",
  "skills": "ì£¼ìš”ìŠ¤í‚¬(ì‰¼í‘œêµ¬ë¶„)",
  "summary": "í•œì¤„ìš”ì•½(50ìì´ë‚´)"
}`;

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { inline_data: { mime_type: 'application/pdf', data: base64 } },
              { text: prompt }
            ]
          }]
        })
      }
    );

    const data = await response.json();
    let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
    text = text.replace(/```json|```/g, '').trim();

    let parsed = {};
    try { parsed = JSON.parse(text); } catch(e) { parsed = {}; }

    barEl.style.width = '100%';
    statusEl.textContent = 'âœ… ì¶”ì¶œ ì™„ë£Œ';
    statusEl.style.color = 'var(--accent3)';

    extractedQueue.push({
      ...parsed,
      fileName: file.name,
      status: 'pending',
      memo: '',
      registeredAt: new Date().toLocaleDateString('ko-KR')
    });

  } catch(e) {
    barEl.style.width = '100%';
    barEl.style.background = 'var(--accent)';
    statusEl.textContent = 'âš ï¸ ì¶”ì¶œ ì‹¤íŒ¨ â€” ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”';
    extractedQueue.push({
      name: file.name.replace('.pdf',''),
      age: 0, gender: 'ë¯¸ìƒ', phone: '', email: '',
      address: '', education: '', school: '', major: '',
      experience_years: 0, position: '', skills: '', summary: '',
      fileName: file.name, status: 'pending', memo: '',
      registeredAt: new Date().toLocaleDateString('ko-KR')
    });
  }
}
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function renderExtractedForms() {
  document.getElementById('extractedResult').style.display = 'block';
  const container = document.getElementById('extractedForms');
  container.innerHTML = extractedQueue.map((c, i) => `
    <div style="border:1px solid var(--border); border-radius:10px; padding:16px; margin-bottom:14px; background:var(--surface2);">
      <div style="font-weight:700; margin-bottom:12px; font-size:13px;">ğŸ“„ ${c.fileName}</div>
      <div class="grid-2" style="gap:10px;">
        <div class="form-group" style="margin-bottom:8px;">
          <label>ì´ë¦„</label>
          <input type="text" id="eq-name-${i}" value="${c.name || ''}">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label>ì§€ì›ë¶„ì•¼</label>
          <input type="text" id="eq-position-${i}" value="${c.position || ''}">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label>ë‚˜ì´</label>
          <input type="number" id="eq-age-${i}" value="${c.age || ''}">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label>ì„±ë³„</label>
          <select id="eq-gender-${i}">
            <option ${c.gender==='ë‚¨'?'selected':''}>ë‚¨</option>
            <option ${c.gender==='ì—¬'?'selected':''}>ì—¬</option>
            <option ${c.gender==='ë¯¸ìƒ'?'selected':''}>ë¯¸ìƒ</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label>ì—°ë½ì²˜</label>
          <input type="text" id="eq-phone-${i}" value="${c.phone || ''}">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label>ì´ë©”ì¼</label>
          <input type="text" id="eq-email-${i}" value="${c.email || ''}">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label>ì£¼ì†Œ</label>
          <input type="text" id="eq-address-${i}" value="${c.address || ''}">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label>ìµœì¢…í•™ë ¥</label>
          <select id="eq-education-${i}">
            <option ${c.education==='ê³ ì¡¸'?'selected':''}>ê³ ì¡¸</option>
            <option ${c.education==='ì „ë¬¸ëŒ€ì¡¸'?'selected':''}>ì „ë¬¸ëŒ€ì¡¸</option>
            <option ${c.education==='ëŒ€ì¡¸'?'selected':''}>ëŒ€ì¡¸</option>
            <option ${c.education==='ëŒ€í•™ì›ì¡¸'?'selected':''}>ëŒ€í•™ì›ì¡¸</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label>í•™êµëª…</label>
          <input type="text" id="eq-school-${i}" value="${c.school || ''}">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label>ì „ê³µ</label>
          <input type="text" id="eq-major-${i}" value="${c.major || ''}">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label>ê²½ë ¥(ë…„)</label>
          <input type="number" id="eq-exp-${i}" value="${c.experience_years || 0}">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label>ì£¼ìš” ìŠ¤í‚¬</label>
          <input type="text" id="eq-skills-${i}" value="${c.skills || ''}">
        </div>
      </div>
      <div class="form-group" style="margin-bottom:0;">
        <label>í•œì¤„ ìš”ì•½</label>
        <input type="text" id="eq-summary-${i}" value="${c.summary || ''}">
      </div>
    </div>`).join('');
}

function saveAllCandidates() {
  extractedQueue.forEach((c, i) => {
    const newCandidate = {
      id: Date.now() + i,
      name: document.getElementById(`eq-name-${i}`)?.value || c.name,
      position: document.getElementById(`eq-position-${i}`)?.value || c.position,
      age: parseInt(document.getElementById(`eq-age-${i}`)?.value) || c.age,
      gender: document.getElementById(`eq-gender-${i}`)?.value || c.gender,
      phone: document.getElementById(`eq-phone-${i}`)?.value || c.phone,
      email: document.getElementById(`eq-email-${i}`)?.value || c.email,
      address: document.getElementById(`eq-address-${i}`)?.value || c.address,
      education: document.getElementById(`eq-education-${i}`)?.value || c.education,
      school: document.getElementById(`eq-school-${i}`)?.value || c.school,
      major: document.getElementById(`eq-major-${i}`)?.value || c.major,
      experience_years: parseInt(document.getElementById(`eq-exp-${i}`)?.value) || 0,
      skills: document.getElementById(`eq-skills-${i}`)?.value || c.skills,
      summary: document.getElementById(`eq-summary-${i}`)?.value || c.summary,
      status: 'pending',
      memo: '',
      registeredAt: new Date().toLocaleDateString('ko-KR')
    };
    candidates.push(newCandidate);
  });

  localStorage.setItem('recruitCandidates', JSON.stringify(candidates));
  updateStats();
  updatePositionFilter();
  alert(`âœ… ${extractedQueue.length}ëª…ì˜ ì§€ì›ìê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
  resetUpload();
  navigate('candidates');
}

function resetUpload() {
  extractedQueue = [];
  document.getElementById('uploadProgress').style.display = 'none';
  document.getElementById('extractedResult').style.display = 'none';
  document.getElementById('pdfInput').value = '';
}

// â”€â”€ ì§€ì›ì ëª©ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function statusBadge(status) {
  const map = {
    pending: ['ê²€í†  ëŒ€ê¸°', 'status-pending'],
    review: ['ê²€í†  ì¤‘', 'status-review'],
    pass: ['âœ“ í•©ê²©', 'status-pass'],
    fail: ['âœ— ë¶ˆí•©ê²©', 'status-fail'],
    hold: ['ë³´ë¥˜', 'status-hold']
  };
  const [label, cls] = map[status] || ['ë¯¸ì •', 'status-hold'];
  return `<span class="status-badge ${cls}">${label}</span>`;
}

function renderCandidateTable() {
  const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
  const statusFilter = document.getElementById('filterStatus')?.value || '';
  const posFilter = document.getElementById('filterPosition')?.value || '';

  let filtered = candidates.filter(c => {
    const matchSearch = !search || c.name?.toLowerCase().includes(search) || c.position?.toLowerCase().includes(search);
    const matchStatus = !statusFilter || c.status === statusFilter;
    const matchPos = !posFilter || c.position === posFilter;
    return matchSearch && matchStatus && matchPos;
  });

  const tbody = document.getElementById('candidateTableBody');
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:40px; color:var(--ink-muted);">ì§€ì›ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    return;
  }

  tbody.innerHTML = filtered.map(c => `
    <tr>
      <td>
        <div class="candidate-name">${c.name || '-'}</div>
        <div class="candidate-meta">${c.summary || ''}</div>
      </td>
      <td><strong>${c.position || '-'}</strong></td>
      <td>${c.age ? c.age + 'ì„¸' : '-'}</td>
      <td>${c.education || '-'}<br><span style="font-size:11px; color:var(--ink-muted);">${c.school || ''} ${c.major || ''}</span></td>
      <td>${c.experience_years ? c.experience_years + 'ë…„' : 'ì‹ ì…'}</td>
      <td style="font-size:12px;">${c.phone || '-'}</td>
      <td>
        <select onchange="updateStatus(${c.id}, this.value)" style="width:100px; padding:4px 6px; font-size:11px;">
          <option value="pending" ${c.status==='pending'?'selected':''}>ê²€í†  ëŒ€ê¸°</option>
          <option value="review" ${c.status==='review'?'selected':''}>ê²€í†  ì¤‘</option>
          <option value="pass" ${c.status==='pass'?'selected':''}>í•©ê²©</option>
          <option value="fail" ${c.status==='fail'?'selected':''}>ë¶ˆí•©ê²©</option>
          <option value="hold" ${c.status==='hold'?'selected':''}>ë³´ë¥˜</option>
        </select>
      </td>
      <td style="font-size:11px; color:var(--ink-muted);">${c.registeredAt || '-'}</td>
      <td>
        <div style="display:flex; gap:4px;">
          <button class="btn btn-secondary" style="padding:4px 8px; font-size:11px;" onclick="openCandidateModal(${c.id})">ìƒì„¸</button>
          <button class="btn btn-danger" style="padding:4px 8px; font-size:11px;" onclick="deleteCandidate(${c.id})">ì‚­ì œ</button>
        </div>
      </td>
    </tr>`).join('');
}

function updatePositionFilter() {
  const positions = [...new Set(candidates.map(c => c.position).filter(Boolean))];
  const sel = document.getElementById('filterPosition');
  if (!sel) return;
  sel.innerHTML = '<option value="">ì „ì²´ ì§€ì›ë¶„ì•¼</option>' +
    positions.map(p => `<option value="${p}">${p}</option>`).join('');
}

function updateStatus(id, status) {
  const c = candidates.find(c => c.id === id);
  if (c) {
    c.status = status;
    localStorage.setItem('recruitCandidates', JSON.stringify(candidates));
    updateStats();
  }
}

function deleteCandidate(id) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  candidates = candidates.filter(c => c.id !== id);
  localStorage.setItem('recruitCandidates', JSON.stringify(candidates));
  updateStats();
  renderCandidateTable();
}

// â”€â”€ ì§€ì›ì ìƒì„¸ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCandidateModal(id) {
  const c = candidates.find(c => c.id === id);
  if (!c) return;

  document.getElementById('modalTitle').textContent = `${c.name} â€” ${c.position}`;
  document.getElementById('modalContent').innerHTML = `
    <div class="grid-2" style="gap:10px; margin-bottom:16px;">
      <div><label>ì´ë¦„</label><input type="text" id="mod-name" value="${c.name || ''}"></div>
      <div><label>ì§€ì›ë¶„ì•¼</label><input type="text" id="mod-position" value="${c.position || ''}"></div>
      <div><label>ë‚˜ì´</label><input type="number" id="mod-age" value="${c.age || ''}"></div>
      <div><label>ì„±ë³„</label><select id="mod-gender">
        <option ${c.gender==='ë‚¨'?'selected':''}>ë‚¨</option>
        <option ${c.gender==='ì—¬'?'selected':''}>ì—¬</option>
        <option ${c.gender==='ë¯¸ìƒ'?'selected':''}>ë¯¸ìƒ</option>
      </select></div>
      <div><label>ì—°ë½ì²˜</label><input type="text" id="mod-phone" value="${c.phone || ''}"></div>
      <div><label>ì´ë©”ì¼</label><input type="text" id="mod-email" value="${c.email || ''}"></div>
      <div><label>ì£¼ì†Œ</label><input type="text" id="mod-address" value="${c.address || ''}"></div>
      <div><label>ìµœì¢…í•™ë ¥</label><select id="mod-education">
        <option ${c.education==='ê³ ì¡¸'?'selected':''}>ê³ ì¡¸</option>
        <option ${c.education==='ì „ë¬¸ëŒ€ì¡¸'?'selected':''}>ì „ë¬¸ëŒ€ì¡¸</option>
        <option ${c.education==='ëŒ€ì¡¸'?'selected':''}>ëŒ€ì¡¸</option>
        <option ${c.education==='ëŒ€í•™ì›ì¡¸'?'selected':''}>ëŒ€í•™ì›ì¡¸</option>
      </select></div>
      <div><label>í•™êµ</label><input type="text" id="mod-school" value="${c.school || ''}"></div>
      <div><label>ì „ê³µ</label><input type="text" id="mod-major" value="${c.major || ''}"></div>
      <div><label>ê²½ë ¥(ë…„)</label><input type="number" id="mod-exp" value="${c.experience_years || 0}"></div>
      <div><label>í•©ê²© ì—¬ë¶€</label><select id="mod-status">
        <option value="pending" ${c.status==='pending'?'selected':''}>ê²€í†  ëŒ€ê¸°</option>
        <option value="review" ${c.status==='review'?'selected':''}>ê²€í†  ì¤‘</option>
        <option value="pass" ${c.status==='pass'?'selected':''}>í•©ê²©</option>
        <option value="fail" ${c.status==='fail'?'selected':''}>ë¶ˆí•©ê²©</option>
        <option value="hold" ${c.status==='hold'?'selected':''}>ë³´ë¥˜</option>
      </select></div>
    </div>
    <div class="form-group">
      <label>ì£¼ìš” ìŠ¤í‚¬</label>
      <input type="text" id="mod-skills" value="${c.skills || ''}">
    </div>
    <div class="form-group">
      <label>ë©”ëª¨ / í‰ê°€ ì˜ê²¬</label>
      <textarea id="mod-memo" rows="3">${c.memo || ''}</textarea>
    </div>
    <div style="display:flex; gap:8px; margin-top:16px;">
      <button class="btn btn-accent" onclick="saveCandidateModal(${id})">ğŸ’¾ ì €ì¥</button>
      <button class="btn btn-secondary" onclick="aiReviewCandidate(${id})">ğŸ¤– AI ê²€í† </button>
      <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
    <div id="modalAIResult" style="display:none; margin-top:12px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:14px; font-size:13px; line-height:1.7;"></div>`;

  document.getElementById('candidateModal').classList.add('open');
}

function saveCandidateModal(id) {
  const c = candidates.find(c => c.id === id);
  if (!c) return;
  c.name = document.getElementById('mod-name').value;
  c.position = document.getElementById('mod-position').value;
  c.age = parseInt(document.getElementById('mod-age').value) || 0;
  c.gender = document.getElementById('mod-gender').value;
  c.phone = document.getElementById('mod-phone').value;
  c.email = document.getElementById('mod-email').value;
  c.address = document.getElementById('mod-address').value;
  c.education = document.getElementById('mod-education').value;
  c.school = document.getElementById('mod-school').value;
  c.major = document.getElementById('mod-major').value;
  c.experience_years = parseInt(document.getElementById('mod-exp').value) || 0;
  c.status = document.getElementById('mod-status').value;
  c.skills = document.getElementById('mod-skills').value;
  c.memo = document.getElementById('mod-memo').value;
  localStorage.setItem('recruitCandidates', JSON.stringify(candidates));
  updateStats();
  renderCandidateTable();
  closeModal();
}

async function aiReviewCandidate(id) {
  const c = candidates.find(c => c.id === id);
  if (!c) return;
  const el = document.getElementById('modalAIResult');
  el.style.display = 'block';
  el.innerHTML = '<div class="loading"><span></span><span></span><span></span></div> AIê°€ ê²€í†  ì¤‘...';

  const prompt = `ë‹¤ìŒ ì§€ì›ì ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì±„ìš© ê²€í†  ì˜ê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

ì´ë¦„: ${c.name}
ì§€ì›ë¶„ì•¼: ${c.position}
ë‚˜ì´: ${c.age}ì„¸
í•™ë ¥: ${c.education} (${c.school} ${c.major})
ê²½ë ¥: ${c.experience_years}ë…„
ìŠ¤í‚¬: ${c.skills}
ìš”ì•½: ${c.summary}

ë‹¤ìŒì„ í¬í•¨í•´ ì£¼ì„¸ìš”:
1. ì§€ì›ì ê°•ì 
2. ìš°ë ¤ ì‚¬í•­
3. ë©´ì ‘ ì¶”ì²œ ì§ˆë¬¸ 3ê°œ
4. ì¢…í•© ì˜ê²¬ (í•©ê²© ê¶Œê³  ì—¬ë¶€)`;

  await callClaude(prompt, 'modalAIResult');
}

function closeModal() {
  document.getElementById('candidateModal').classList.remove('open');
}

// â”€â”€ ë¶„ì„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAnalysis() {
  const statusMap = {pending:'ê²€í†  ëŒ€ê¸°', review:'ê²€í†  ì¤‘', pass:'í•©ê²©', fail:'ë¶ˆí•©ê²©', hold:'ë³´ë¥˜'};
  const statusColors = {pending:'var(--accent4)', review:'var(--accent2)', pass:'var(--accent3)', fail:'var(--accent)', hold:'var(--ink-muted)'};

  const statusCount = {};
  candidates.forEach(c => { statusCount[c.status] = (statusCount[c.status] || 0) + 1; });

  const statusEl = document.getElementById('statusChart');
  if (candidates.length === 0) {
    statusEl.innerHTML = '<div style="text-align:center; padding:30px; color:var(--ink-muted);">ë°ì´í„° ì—†ìŒ</div>';
  } else {
    statusEl.innerHTML = Object.entries(statusCount).map(([s, cnt]) => `
      <div style="margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
          <span style="font-weight:600;">${statusMap[s] || s}</span>
          <span style="color:var(--ink-muted);">${cnt}ëª… (${(cnt/candidates.length*100).toFixed(0)}%)</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" style="width:${(cnt/candidates.length*100).toFixed(0)}%; background:${statusColors[s]}"></div></div>
      </div>`).join('');
  }

  const posMap = {};
  candidates.forEach(c => { if (c.position) posMap[c.position] = (posMap[c.position] || 0) + 1; });
  const posEl = document.getElementById('positionChart');
  if (Object.keys(posMap).length === 0) {
    posEl.innerHTML = '<div style="text-align:center; padding:30px; color:var(--ink-muted);">ë°ì´í„° ì—†ìŒ</div>';
  } else {
    const max = Math.max(...Object.values(posMap));
    posEl.innerHTML = Object.entries(posMap).map(([p, cnt]) => `
      <div style="margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
          <span style="font-weight:600;">${p}</span>
          <span style="color:var(--ink-muted);">${cnt}ëª…</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" style="width:${(cnt/max*100).toFixed(0)}%"></div></div>
      </div>`).join('');
  }
}

async function generateAnalysisReport() {
  const el = document.getElementById('analysisReport');
  el.style.display = 'block';
  el.innerHTML = 'ë¶„ì„ ì¤‘...';

  const total = candidates.length;
  const pass = candidates.filter(c => c.status === 'pass').length;
  const positions = [...new Set(candidates.map(c => c.position).filter(Boolean))];
  const avgAge = candidates.length ? Math.round(candidates.reduce((s,c) => s + (c.age||0), 0) / candidates.length) : 0;

  const prompt = `ì±„ìš© ë‹´ë‹¹ìë¡œì„œ ë‹¤ìŒ ì±„ìš© í˜„í™©ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”.

ì´ ì§€ì›ì: ${total}ëª…
í•©ê²©ì: ${pass}ëª…
í•©ê²©ë¥ : ${total ? (pass/total*100).toFixed(1) : 0}%
í‰ê·  ë‚˜ì´: ${avgAge}ì„¸
ì§€ì›ë¶„ì•¼: ${positions.join(', ')}

ë‹¤ìŒì„ í¬í•¨í•œ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”:
1. ì „ë°˜ì ì¸ ì±„ìš© í˜„í™© ìš”ì•½
2. ì§€ì› ë¶„ì•¼ë³„ ê²½ìŸë¥  ë¶„ì„
3. ê°œì„  ê¶Œê³ ì‚¬í•­
4. ë‹¤ìŒ ì±„ìš© ì‹œ ê³ ë ¤í•  ì `;

  await callClaude(prompt, 'analysisReport');
}

// â”€â”€ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportToExcel() {
  if (candidates.length === 0) { alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

  const statusMap = {pending:'ê²€í†  ëŒ€ê¸°', review:'ê²€í†  ì¤‘', pass:'í•©ê²©', fail:'ë¶ˆí•©ê²©', hold:'ë³´ë¥˜'};
  let csv = 'ì´ë¦„,ì§€ì›ë¶„ì•¼,ë‚˜ì´,ì„±ë³„,ì—°ë½ì²˜,ì´ë©”ì¼,ì£¼ì†Œ,ìµœì¢…í•™ë ¥,í•™êµ,ì „ê³µ,ê²½ë ¥(ë…„),ì£¼ìš”ìŠ¤í‚¬,í•©ê²©ì—¬ë¶€,ë©”ëª¨,ë“±ë¡ì¼\n';
  candidates.forEach(c => {
    csv += [
      c.name, c.position, c.age, c.gender, c.phone, c.email,
      c.address, c.education, c.school, c.major, c.experience_years,
      c.skills, statusMap[c.status] || c.status, c.memo?.replace(/,/g,'ï¼›'), c.registeredAt
    ].map(v => `"${v || ''}"`).join(',') + '\n';
  });

  const blob = new Blob(['\uFEFF' + csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ì±„ìš©ê´€ë¦¬_${new Date().toLocaleDateString('ko-KR').replace(/\./g,'').replace(/ /g,'')}.csv`;
  a.click();
}

// â”€â”€ AI Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  appendMsg(msg, 'user');
  input.value = '';

  const aiDiv = appendMsg('<div class="loading"><span></span><span></span><span></span></div>', 'ai');

  const systemPrompt = `ë‹¹ì‹ ì€ ì±„ìš© ê´€ë¦¬ ì „ë¬¸ AI ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤. ë‹¤ìŒ ë¶„ì•¼ë¥¼ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤:
- ì±„ìš© ê³µê³  ì‘ì„± ë° ì§ë¬´ ë¶„ì„
- ì´ë ¥ì„œ ê²€í†  ê¸°ì¤€ ë° í‰ê°€ ë°©ë²•
- ë©´ì ‘ ì§ˆë¬¸ ì¶”ì²œ ë° í‰ê°€ ê¸°ì¤€
- í•©ê²©/ë¶ˆí•©ê²© íŒë‹¨ ê°€ì´ë“œ
- ì±„ìš© ê´€ë ¨ ë…¸ë¬´ ë²•ê·œ ì•ˆë‚´

í˜„ì¬ ë“±ë¡ëœ ì§€ì›ì ìˆ˜: ${candidates.length}ëª…
í•­ìƒ í•œêµ­ì–´ë¡œ ì¹œì ˆí•˜ê²Œ ë‹µë³€í•´ ì£¼ì„¸ìš”.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: [{ role: 'user', content: msg }]
      })
    });
    const data = await response.json();
    const text = data.content?.map(b => b.text).join('') || 'ì‘ë‹µ ì—†ìŒ';
    aiDiv.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  } catch(e) {
    aiDiv.innerHTML = 'âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
  }
}

function appendMsg(text, role) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `msg msg-${role}`;
  div.innerHTML = text;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div;
}

document.getElementById('chatInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
});

// â”€â”€ Claude API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callClaude(prompt, targetId) {
  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{ role: 'user', content: prompt }]
      })
    });
    const data = await response.json();
    const text = data.content?.map(b => b.text).join('') || 'ì‘ë‹µ ì—†ìŒ';
    document.getElementById(targetId).innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  } catch(e) {
    document.getElementById(targetId).innerHTML = 'âš ï¸ AI ì—°ê²° ì˜¤ë¥˜';
  }
}

// â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateStats();
updatePositionFilter();
renderDashboard();
loadEmailJSConfig();
loadEmailTemplate();
loadBulkTemplate();
renderEmailLog();

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
document.getElementById('candidateModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// â”€â”€ ì´ë©”ì¼ íƒ­ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchEmailTab(el, targetId) {
  el.closest('.tabs').querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  ['email-template','email-bulk','email-log'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
  document.getElementById(targetId).style.display = 'block';
  if (targetId === 'email-log') renderEmailLog();
}

// â”€â”€ EmailJS ì„¤ì • ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveEmailJSConfig() {
  const cfg = {
    serviceId: document.getElementById('ejsServiceId').value.trim(),
    templateId: document.getElementById('ejsTemplateId').value.trim(),
    publicKey: document.getElementById('ejsPublicKey').value.trim()
  };
  localStorage.setItem('emailJSConfig', JSON.stringify(cfg));
  const el = document.getElementById('ejsConfigStatus');
  el.textContent = 'âœ… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
  el.style.color = 'var(--accent3)';
  setTimeout(() => el.textContent = '', 3000);
}

function loadEmailJSConfig() {
  const cfg = JSON.parse(localStorage.getItem('emailJSConfig') || '{}');
  if (cfg.serviceId) document.getElementById('ejsServiceId').value = cfg.serviceId;
  if (cfg.templateId) document.getElementById('ejsTemplateId').value = cfg.templateId;
  if (cfg.publicKey) document.getElementById('ejsPublicKey').value = cfg.publicKey;
}

function getEmailJSConfig() {
  return JSON.parse(localStorage.getItem('emailJSConfig') || '{}');
}

// â”€â”€ ìˆ˜ì‹ ì ëª©ë¡ ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateEmailRecipientList() {
  const sel = document.getElementById('emailRecipient');
  if (!sel) return;
  sel.innerHTML = '<option value="">â€” ì§€ì›ì ì„ íƒ â€”</option>' +
    candidates.map(c => `<option value="${c.id}">${c.name} (${c.position}) â€” ${c.email || 'ì´ë©”ì¼ ì—†ìŒ'}</option>`).join('');
}

document.getElementById('emailRecipient')?.addEventListener('change', function() {
  const c = candidates.find(c => c.id === parseInt(this.value));
  if (c) {
    document.getElementById('emailTo').value = c.email || '';
    updateEmailPreview();
  }
});

// â”€â”€ ì´ë©”ì¼ í…œí”Œë¦¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EMAIL_TEMPLATES = {
  pass: {
    subject: '[ì±„ìš© ê²°ê³¼ ì•ˆë‚´] ì„œë¥˜ì „í˜• í•©ê²©ì„ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤',
    body: `ì•ˆë…•í•˜ì„¸ìš”, {ì´ë¦„}ë‹˜.

ì €í¬ íšŒì‚¬ì— ì§€ì›í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.

ì„œë¥˜ì „í˜• ê²€í†  ê²°ê³¼, {ì´ë¦„}ë‹˜ì„ í•©ê²©ìë¡œ ì„ ë°œí•˜ê²Œ ë˜ì—ˆìŒì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤. ğŸ‰

ë‹¤ìŒ ì „í˜•(ë©´ì ‘)ì— ëŒ€í•œ ì•ˆë‚´ëŠ” ë³„ë„ë¡œ ì—°ë½ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.

ì•ìœ¼ë¡œë„ ì˜ ë¶€íƒë“œë¦½ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`
  },
  fail: {
    subject: '[ì±„ìš© ê²°ê³¼ ì•ˆë‚´] ì§€ì›í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤',
    body: `ì•ˆë…•í•˜ì„¸ìš”, {ì´ë¦„}ë‹˜.

ì €í¬ íšŒì‚¬ì— ê´€ì‹¬ì„ ê°€ì§€ê³  ì§€ì›í•´ ì£¼ì…”ì„œ ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.

ì‹ ì¤‘í•œ ê²€í†  ëì—, ì´ë²ˆì—ëŠ” í•¨ê»˜í•˜ê¸° ì–´ë µê²Œ ë˜ì—ˆìŒì„ ë§ì”€ë“œë¦½ë‹ˆë‹¤.
ë¶€ì¡±í•œ ë¶€ë¶„ì´ ìˆë‹¤ë©´ ë‚´ë¶€ ì‚¬ì •ì— ì˜í•œ ê²ƒìœ¼ë¡œ, {ì´ë¦„}ë‹˜ì˜ ì—­ëŸ‰ì´ ë¶€ì¡±í•´ì„œê°€ ì•„ë‹˜ì„ ë§ì”€ë“œë¦½ë‹ˆë‹¤.

ì•ìœ¼ë¡œì˜ ì·¨ì—… í™œë™ì— ì¢‹ì€ ê²°ê³¼ê°€ ìˆìœ¼ì‹œê¸¸ ë°”ëë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`
  },
  interview: {
    subject: '[ë©´ì ‘ ì•ˆë‚´] ë©´ì ‘ ì¼ì •ì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤',
    body: `ì•ˆë…•í•˜ì„¸ìš”, {ì´ë¦„}ë‹˜.

ì„œë¥˜ì „í˜• í•©ê²©ì„ ë‹¤ì‹œ í•œë²ˆ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤.

ì•„ë˜ì™€ ê°™ì´ ë©´ì ‘ ì¼ì •ì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.

ğŸ“… ë©´ì ‘ ì¼ì‹œ: 
ğŸ“ ë©´ì ‘ ì¥ì†Œ: 
â± ì†Œìš” ì‹œê°„: ì•½ 1ì‹œê°„

ë©´ì ‘ ì‹œ ì‹ ë¶„ì¦ì„ ì§€ì°¸í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
ì¼ì • ë³€ê²½ì´ í•„ìš”í•˜ì‹  ê²½ìš° íšŒì‹  ë¶€íƒë“œë¦½ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`
  },
  document: {
    subject: '[ì ‘ìˆ˜ í™•ì¸] ì§€ì›ì„œê°€ ì •ìƒ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤',
    body: `ì•ˆë…•í•˜ì„¸ìš”, {ì´ë¦„}ë‹˜.

ì €í¬ íšŒì‚¬ì— ì§€ì›í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.

{ì´ë¦„}ë‹˜ì˜ ì§€ì›ì„œê°€ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŒì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.
ì„œë¥˜ ê²€í†  í›„ ê²°ê³¼ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì•ˆë‚´ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`
  },
  custom: { subject: '', body: '' }
};

function loadEmailTemplate() {
  const type = document.getElementById('emailType')?.value;
  if (!type || type === 'custom') return;
  const t = EMAIL_TEMPLATES[type];
  if (t) {
    document.getElementById('emailSubject').value = t.subject;
    document.getElementById('emailBody').value = t.body;
    updateEmailPreview();
  }
}

function loadBulkTemplate() {
  const type = document.getElementById('bulkEmailType')?.value;
  if (!type) return;
  const t = EMAIL_TEMPLATES[type];
  if (t) {
    document.getElementById('bulkSubject').value = t.subject;
    document.getElementById('bulkBody').value = t.body;
  }
}

// â”€â”€ ì´ë©”ì¼ ë¯¸ë¦¬ë³´ê¸° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
['emailSubject','emailBody','emailTo'].forEach(id => {
  document.getElementById(id)?.addEventListener('input', updateEmailPreview);
});

function updateEmailPreview() {
  const subject = document.getElementById('emailSubject')?.value || '';
  const body = document.getElementById('emailBody')?.value || '';
  const to = document.getElementById('emailTo')?.value || '';
  const recipId = document.getElementById('emailRecipient')?.value;
  const c = candidates.find(c => c.id === parseInt(recipId));
  const name = c?.name || '{ì´ë¦„}';
  const bodyReplaced = body.replace(/\{ì´ë¦„\}/g, name);

  document.getElementById('emailPreview').innerHTML = `
    <div style="border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:14px;">
      <div style="font-size:11px; color:var(--ink-muted); margin-bottom:4px;">ìˆ˜ì‹ </div>
      <div style="font-size:13px;">${to || '(ìˆ˜ì‹ ì ë¯¸ì„ íƒ)'}</div>
    </div>
    <div style="border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:14px;">
      <div style="font-size:11px; color:var(--ink-muted); margin-bottom:4px;">ì œëª©</div>
      <div style="font-size:14px; font-weight:700;">${subject || '(ì œëª© ì—†ìŒ)'}</div>
    </div>
    <div style="font-size:13px; line-height:1.8; white-space:pre-wrap;">${bodyReplaced || '(ë³¸ë¬¸ ì—†ìŒ)'}</div>`;
}

// â”€â”€ ì´ë©”ì¼ ë°œì†¡ (EmailJS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadEmailJS(callback) {
  if (window.emailjs) { callback(); return; }
  const s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
  s.onload = () => {
    const cfg = getEmailJSConfig();
    if (cfg.publicKey) emailjs.init(cfg.publicKey);
    callback();
  };
  document.head.appendChild(s);
}

async function sendEmail() {
  const cfg = getEmailJSConfig();
  if (!cfg.serviceId || !cfg.templateId || !cfg.publicKey) {
    alert('EmailJS ì„¤ì •ì„ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”!');
    return;
  }

  const to = document.getElementById('emailTo').value.trim();
  const subject = document.getElementById('emailSubject').value.trim();
  const body = document.getElementById('emailBody').value.trim();
  const recipId = document.getElementById('emailRecipient').value;
  const c = candidates.find(c => c.id === parseInt(recipId));

  if (!to) { alert('ìˆ˜ì‹ ì ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  if (!subject) { alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

  const statusEl = document.getElementById('emailSendStatus');
  statusEl.innerHTML = '<div class="loading"><span></span><span></span><span></span></div> ë°œì†¡ ì¤‘...';

  const bodyFinal = body.replace(/\{ì´ë¦„\}/g, c?.name || '');

  loadEmailJS(async () => {
    try {
      await emailjs.send(cfg.serviceId, cfg.templateId, {
        to_email: to,
        to_name: c?.name || '',
        subject: subject,
        message: bodyFinal
      });

      statusEl.textContent = 'âœ… ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!';
      statusEl.style.color = 'var(--accent3)';
      addEmailLog(c?.name || to, to, subject, 'ì„±ê³µ');
    } catch(e) {
      statusEl.textContent = 'âŒ ë°œì†¡ ì‹¤íŒ¨: ' + (e.text || e.message || 'ì˜¤ë¥˜');
      statusEl.style.color = 'var(--accent)';
      addEmailLog(c?.name || to, to, subject, 'ì‹¤íŒ¨');
    }
  });
}

// â”€â”€ ì¼ê´„ ë°œì†¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function previewBulkRecipients() {
  const target = document.getElementById('bulkTarget').value;
  const list = target === 'all' ? candidates : candidates.filter(c => c.status === target);
  const el = document.getElementById('bulkPreviewList');

  if (list.length === 0) {
    el.innerHTML = '<div style="color:var(--accent); font-size:13px;">í•´ë‹¹ ìƒíƒœì˜ ì§€ì›ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  el.innerHTML = `<div style="background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:8px;">
    <div style="font-weight:700; margin-bottom:8px; font-size:13px;">ğŸ“‹ ë°œì†¡ ëŒ€ìƒ ${list.length}ëª…</div>
    ${list.map(c => `<div style="display:flex; gap:8px; font-size:12px; padding:4px 0; border-bottom:1px solid var(--border);">
      <span style="font-weight:600; width:80px;">${c.name}</span>
      <span style="color:var(--ink-muted);">${c.email || 'âš ï¸ ì´ë©”ì¼ ì—†ìŒ'}</span>
    </div>`).join('')}
  </div>
  <div style="font-size:12px; color:var(--ink-muted);">âš ï¸ ì´ë©”ì¼ì´ ì—†ëŠ” ì§€ì›ìëŠ” ë°œì†¡ì´ ê±´ë„ˆëœë‹ˆë‹¤.</div>`;
}

async function sendBulkEmail() {
  const cfg = getEmailJSConfig();
  if (!cfg.serviceId || !cfg.templateId || !cfg.publicKey) {
    alert('EmailJS ì„¤ì •ì„ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”!');
    return;
  }

  const target = document.getElementById('bulkTarget').value;
  const subject = document.getElementById('bulkSubject').value.trim();
  const bodyTemplate = document.getElementById('bulkBody').value.trim();
  const list = (target === 'all' ? candidates : candidates.filter(c => c.status === target))
    .filter(c => c.email);

  if (list.length === 0) { alert('ë°œì†¡ ê°€ëŠ¥í•œ ì´ë©”ì¼ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  if (!confirm(`${list.length}ëª…ì—ê²Œ ì´ë©”ì¼ì„ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  const statusEl = document.getElementById('bulkSendStatus');
  statusEl.innerHTML = `<div class="loading"><span></span><span></span><span></span></div> 0 / ${list.length} ë°œì†¡ ì¤‘...`;

  loadEmailJS(async () => {
    let success = 0, fail = 0;
    for (const c of list) {
      const body = bodyTemplate.replace(/\{ì´ë¦„\}/g, c.name || '');
      try {
        await emailjs.send(cfg.serviceId, cfg.templateId, {
          to_email: c.email,
          to_name: c.name || '',
          subject: subject,
          message: body
        });
        success++;
        addEmailLog(c.name, c.email, subject, 'ì„±ê³µ');
      } catch(e) {
        fail++;
        addEmailLog(c.name, c.email, subject, 'ì‹¤íŒ¨');
      }
      statusEl.innerHTML = `ë°œì†¡ ì¤‘... ${success + fail} / ${list.length}`;
      await new Promise(r => setTimeout(r, 500));
    }
    statusEl.innerHTML = `âœ… ì™„ë£Œ: ì„±ê³µ ${success}ê±´ / ì‹¤íŒ¨ ${fail}ê±´`;
    statusEl.style.color = fail > 0 ? 'var(--accent)' : 'var(--accent3)';
  });
}

// â”€â”€ ë°œì†¡ ê¸°ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addEmailLog(name, email, subject, result) {
  const logs = JSON.parse(localStorage.getItem('emailLogs') || '[]');
  logs.unshift({
    name, email, subject, result,
    time: new Date().toLocaleString('ko-KR')
  });
  localStorage.setItem('emailLogs', JSON.stringify(logs.slice(0, 100)));
}

function renderEmailLog() {
  const logs = JSON.parse(localStorage.getItem('emailLogs') || '[]');
  const el = document.getElementById('emailLogContent');
  if (!el) return;
  if (logs.length === 0) {
    el.innerHTML = '<div style="text-align:center; padding:30px; color:var(--ink-muted); font-size:13px;">ë°œì†¡ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  el.innerHTML = `<table class="recruit-table">
    <thead><tr><th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ì œëª©</th><th>ê²°ê³¼</th><th>ì‹œê°„</th></tr></thead>
    <tbody>${logs.map(l => `<tr>
      <td>${l.name}</td>
      <td style="font-size:12px;">${l.email}</td>
      <td style="font-size:12px;">${l.subject}</td>
      <td><span style="color:${l.result==='ì„±ê³µ'?'var(--accent3)':'var(--accent)'}; font-weight:700;">${l.result}</span></td>
      <td style="font-size:11px; color:var(--ink-muted);">${l.time}</td>
    </tr>`).join('')}</tbody>
  </table>`;
}

function clearEmailLog() {
  if (!confirm('ë°œì†¡ ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  localStorage.removeItem('emailLogs');
  renderEmailLog();
}

// â”€â”€ AI ì´ë©”ì¼ ì‘ì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function aiWriteEmail() {
  const type = document.getElementById('emailType').value;
  const recipId = document.getElementById('emailRecipient').value;
  const c = candidates.find(c => c.id === parseInt(recipId));

  const typeMap = {pass:'í•©ê²©', fail:'ë¶ˆí•©ê²©', interview:'ë©´ì ‘ ì•ˆë‚´', document:'ì„œë¥˜ ì ‘ìˆ˜ í™•ì¸', custom:'ì¼ë°˜'};
  const statusEl = document.getElementById('emailSendStatus');
  statusEl.innerHTML = '<div class="loading"><span></span><span></span><span></span></div> AIê°€ ì´ë©”ì¼ì„ ì‘ì„± ì¤‘...';

  const prompt = `ì±„ìš© ë‹´ë‹¹ìë¡œì„œ ì•„ë˜ ìƒí™©ì— ë§ëŠ” ì •ì¤‘í•˜ê³  ë”°ëœ»í•œ í•œêµ­ì–´ ì´ë©”ì¼ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.

ì´ë©”ì¼ ìœ í˜•: ${typeMap[type]} ì•ˆë‚´
ì§€ì›ì ì´ë¦„: ${c?.name || 'ì§€ì›ì'}
ì§€ì› ë¶„ì•¼: ${c?.position || 'ë¯¸ì •'}

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{"subject": "ì œëª©", "body": "ë³¸ë¬¸ ë‚´ìš©"}`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 800,
        messages: [{ role: 'user', content: prompt }]
      })
    });
    const data = await response.json();
    let text = data.content?.map(b => b.text).join('') || '{}';
    text = text.replace(/```json|```/g, '').trim();
    const parsed = JSON.parse(text);
    if (parsed.subject) document.getElementById('emailSubject').value = parsed.subject;
    if (parsed.body) document.getElementById('emailBody').value = parsed.body;
    updateEmailPreview();
    statusEl.textContent = 'âœ… AI ì´ë©”ì¼ ì‘ì„± ì™„ë£Œ!';
    statusEl.style.color = 'var(--accent3)';
  } catch(e) {
    statusEl.textContent = 'âš ï¸ AI ì‘ì„± ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    statusEl.style.color = 'var(--accent)';
  }
}

// navigateì— email/upload í˜ì´ì§€ ì¶”ê°€
const _origNavigate = navigate;
function navigate(page) {
  _origNavigate(page);
  if (page === 'email') {
    updateEmailRecipientList();
    loadEmailJSConfig();
  }
  if (page === 'upload') {
    loadGeminiKey();
  }
}

// ì´ˆê¸° Gemini í‚¤ ë¡œë“œ
loadGeminiKey();
</script>
</body>
</html>
